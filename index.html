<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Web Map</title>
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-control-geocoder.Geocoder.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        /* Move the Basemaps header up and use vw for spacing */
        .leaflet-control-layers-expanded {
            padding-top: 0vw !important;
            padding-right: 1vw !important;
            padding-bottom: 0.5vw !important;
        }
        .custom-basemap-header {
            font-weight: bold;
            color: rgb(0, 0, 0);
            margin: -1.27vw 0 0.5vw 0 !important;
            font-size: 0.5vw;
        }
/* Popup box styling - same as index - Copy, but no width/height */
.leaflet-popup {
    background: #ffffff; /* White background */
    border: 1px solid #ccc; /* Light gray border */
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    font-family: 'Arial', sans-serif; /* Modern font */
    color: #333; /* Text color */
}

.leaflet-popup-content-wrapper {
    border-radius: 10px;
}

.leaflet-popup-content {
    padding: 15px; /* Add padding inside the popup */
    font-size: 14px; /* Adjust font size */
    line-height: 1.5; /* Improve readability */
    /* No width or max-width here */
}

/* Popup close button */
.leaflet-popup-close-button {
    color: #333;
    font-size: 18px;
    font-weight: bold;
    text-shadow: none;
    opacity: 0.8;
}
.leaflet-popup-close-button:hover {
    color: #007bff;
    opacity: 1;
}

/* Table styling inside popup */
.leaflet-popup-content table {
    width: 100%;
    border-collapse: collapse;
}
.leaflet-popup-content th,
.leaflet-popup-content td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    vertical-align: top;
}
.leaflet-popup-content th {
    font-weight: bold;
    color: #555;
}
.leaflet-popup-content img {
    max-width: 100%;
    border-radius: 5px;
    margin-top: 10px;
}
/* ...existing code... */
.overlay {
    display: flex;
    position: fixed;
    top: 50%;
    left: 50%;
    width: 1100px;
    height: 680px;
    max-width: 98vw;
    max-height: 100vh;
    overflow: hidden;
    transform: translate(-50%, -50%) scale(0.92);
    background: rgba(255, 255, 255, 0.97);
    padding: 30px 30px 20px 30px;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.28);
    z-index: 10000;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1), transform 0.5s cubic-bezier(.4,2,.6,1);
    display: flex;
    flex-direction: row;
    align-items: stretch; /* Stretch children vertically */
    justify-content: stretch; /* Stretch children horizontally */
    transform-origin: center center !important;
}

.overlay > div {
    flex: 1 1 0;
    display: flex;
    flex-direction: row;
    height: 100%;
    min-width: 0;
    min-height: 0;
}


.overlay.open {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.34);
    transform-origin: center center !important;
}

.blur-overlay {
    display: none;
    position: fixed;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    transform-origin: center !important;
    top: 0; left: 0; width: 300vw; height: 300vh;
    backdrop-filter: blur(10px);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
}

.close-button {
    position: absolute;
    top: 14px;
    right: 22px;
    font-size: 28px;
    cursor: pointer;
    font-weight: bold;
    color: #333;
    transition: color 0.3s ease;
    z-index: 10;
}
.close-button:hover {
    color: #007bff;
}


.modern-3d-button {
    background: linear-gradient(90deg, #007bff 60%, #0056b3 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 18px;
    font-size: 15px;
    font-family: inherit;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
    margin-top: 12px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    justify-content: center;
    text-align: center;
}
.modern-3d-button:hover, .modern-3d-button:focus {
    background: linear-gradient(90deg, #0056b3 60%, #007bff 100%);
    box-shadow: 0 4px 16px rgba(0,123,255,0.15);
    transform: translateY(-2px) scale(1.04);
    outline: none;
}

audio::-webkit-media-controls-panel {
    background-color: transparent !important; /* Make the background transparent */
    border: none !important; /* Remove any borders */
}

audio::-webkit-media-controls-enclosure {
    background-color: transparent !important; /* Make the enclosure transparent */
    border: none !important; /* Remove any borders */
}


audio {
    background-color: transparent !important; /* Ensure the audio element itself is transparent */
    border: none !important; /* Remove any borders */
    outline: none !important; /* Remove focus outline */
}

/* Invert the entire player for a dark theme */
.audio-player-inverted {
    filter: invert(1); /* Invert all colors */
}

/* Add to your <style> section */
.vertical-tabs {
    display: flex;
    flex: 0 0 130px; /* Fixed width for tabs */
    height: 100%;
    align-items: stretch;
    justify-content: stretch;
    flex-direction: column;
    min-width: 130px;
    margin-right: 24px;
    height: 100%;
    justify-content: stretch;
    align-items: stretch;
    flex: 0 0 130px;
    background: #f7f8fa;
    border-radius: 12px 0 0 12px;
    padding: 6px 0;
    gap: 4px;
    box-shadow: none;
    border-right: 1px solid #ececec;
}
.tab-btn {
    background: none;
    border: none;
    outline: none;
    padding: 16px 14px;
    text-align: left;
    font-size: 1.08em;
    cursor: pointer;
    color: #222;
    transition: 
        background 0.16s cubic-bezier(.4,2,.6,1),
        color 0.16s cubic-bezier(.4,2,.6,1),
        transform 0.16s cubic-bezier(.4,2,.6,1);
    flex: 1 1 0;
    border-radius: 8px 16px 16px 8px;
    width: 100%;
    margin: 0;
    font-weight: 500;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    background: none;
    box-shadow: none;
}
.tab-btn.active, .tab-btn:focus {
    background: #2563eb12;
    color: #2563eb;
    font-weight: 700; /* Make selected tab bold */
}
.tab-btn:hover:not(.active) {
    background: #e7eafc;
    color: #2563eb;
    font-weight: 700; /* Keep font bold on hover for consistency */
    /* Removed transform: scale(1.01) to prevent flicker */
}
.tab-btn::before {
    content: '';
    display: block;
    width: 3px;
    height: 60%;
    background: #2563eb;
    border-radius: 2px;
    position: absolute;
    left: 0;
    top: 20%;
    opacity: 0;
    transition: opacity 0.2s;
}
.tab-btn.active::before {
    opacity: 1;
}

.tab-content.active {
    display: flex;
}


/* Center and scale each tab content */
.tab-content {
    display: none;
    width: 100%;
    height: 100%;
    min-width: 0;
    min-height: 0;
    flex: 1 1 0;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    animation: fadeInTab 0.28s cubic-bezier(.4,2,.6,1);
}
@keyframes fadeInTab {
    from { opacity: 0; transform: translateY(10px);}
    to { opacity: 1; transform: none;}
}
.tab-content:not(:first-child) {
    display: none;
}

/* Carousel Overlay Styling */
#carousel-overlay {
    display: none;
    position: fixed;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    transform-origin: center !important;
    z-index: 20000;
    top: 0; left: 0; width: 300vw; height: 300vh;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
    opacity: 0;
}
#carousel-overlay.open {
    display: flex;
    opacity: 1;
}
.carousel-container {
    background: #fafafa;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.28);
    width: 1100px;
    height: 680px;
    max-width: 98vw;
    max-height: 100vh;
    padding: 30px 30px 20px 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    text-align: center;
    overflow: hidden;
    transition: transform 0.5s cubic-bezier(.4,2,.6,1), opacity 0.5s cubic-bezier(.4,2,.6,1);
    transform: scale(0.92);
    opacity: 0;
}
#carousel-overlay.open .carousel-container {
    transform: scale(1.5);
    opacity: 1;
}
.carousel-slide {
    width: 100%;
    min-height: 180px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    left: 0; top: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.45s cubic-bezier(.4,2,.6,1), transform 0.45s cubic-bezier(.4,2,.6,1);
    transform: translateX(60px);
}
.carousel-slide.active {
    opacity: 1;
    pointer-events: auto;
    position: relative;
    transform: translateX(0);
    z-index: 2;
}
.carousel-slide.slide-out-left {
    opacity: 0;
    transform: translateX(-60px);
    z-index: 1;
}
.carousel-slide.slide-out-right {
    opacity: 0;
    transform: translateX(60px);
    z-index: 1;
}
#carousel-slides {
    position: relative;
    width: 100%;
    height: 90%;
    margin-bottom: 0;
    overflow: hidden;
}

/* Add to your <style> section, after .carousel-slide.slide-out-right */
.carousel-slide.slide-in-right {
    opacity: 1;
    transform: translateX(60px);
    animation: slideInRight 0.45s cubic-bezier(.4,2,.6,1) forwards;
    z-index: 2;
}
.carousel-slide.slide-in-left {
    opacity: 1;
    transform: translateX(-60px);
    animation: slideInLeft 0.45s cubic-bezier(.4,2,.6,1) forwards;
    z-index: 2;
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(60px);}
    to   { opacity: 1; transform: translateX(0);}
}
@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-60px);}
    to   { opacity: 1; transform: translateX(0);}
}
/* Add to your <style> section */
.modern-3d-button:disabled,
.modern-3d-button[disabled] {
    background: #bfc7d1 !important;
    color: #fff !important;
    cursor: default !important;
    box-shadow: none !important;
    opacity: 0.7;
    border: none;
    transform: none !important;
}

.carousel-slide h2 {
    font-size: 2.2em;
    color: #2563eb;
    text-align: center;
    margin-bottom: 30px;
    font-family: 'Arial', sans-serif;
}
.carousel-slide p {
    font-size: 1.18em;
    text-align: justify;
    font-family: 'Arial', sans-serif;
    color: #222;
    margin: 0 auto;
    max-width: 900px;
}

/* Add to your <style> section */
.carousel-container {
    position: relative; /* Ensure children can be absolutely positioned */
}

.carousel-controls-row {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 50px;
    display: flex;
    justify-content: center;
    gap: 16px;
    z-index: 10;
    font-family: 'Arial', sans-serif !important;
    font-size: 1.08em;
}

#carousel-dots {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 30px;
    display: flex;
    justify-content: center;
    gap: 8px;
    z-index: 10;
}

#carousel-checkbox-row {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 120px;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px;
    z-index: 10;
    font-family: 'Arial', sans-serif !important;
    font-size: 1.08em;
}

/* Smooth transition for completion overlay */
#form-redirect-overlay {
    display: none;
    position: fixed;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 20001;
    top: 0; left: 0; width: 300vw; height: 300vh;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
    font-family: Arial, sans-serif !important;
}
#form-redirect-overlay.open {
    display: flex;
    opacity: 1;
}
#form-redirect-overlay .modern-3d-button {
    font-family: Arial, sans-serif !important;
}
#form-redirect-overlay h2,
#form-redirect-overlay p {
    font-family: Arial, sans-serif !important;
}

#carousel-next, #carousel-prev {
    text-align: center !important;
    justify-content: center !important;
    align-items: center !important;
    display: flex !important;
}

#carousel-slides #user-code-input {
    margin-top: 8px !important;
}

.sketchfab-embed-wrapper {
  width: 100%;
  height: 100%;
  min-height: 0;
  min-width: 0;
  display: flex;
  border-radius: 8px;
  overflow: hidden;
}
.sketchfab-embed-wrapper iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}

.modern-3d-button.disabled,
.modern-3d-button:disabled {
    background: #bfc7d1 !important;
    color: #fff !important;
    cursor: not-allowed !important;
    box-shadow: none !important;
    opacity: 0.7;
    border: none;
    transform: none !important;
}

/* 3D Model attribution styling */
.model-attribution {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-family: Arial, sans-serif;
    font-style: italic;
    z-index: 1000;
    pointer-events: none;
    white-space: pre-line;
    max-width: 430px;
    line-height: 1.3;
    text-align: left;
    word-wrap: break-word;
}

.image-attribution {
    position: absolute;
    bottom: 8px;
    right: 8px;
    left: auto;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-family: Arial, sans-serif;
    font-style: italic;
    z-index: 2;
    pointer-events: none;
    white-space: pre-line;
    max-width: 90%;
    line-height: 1.3;
    text-align: left;
    word-wrap: break-word;
}

/* Ensure the model tab has relative positioning for absolute child */
#tab-model {
    position: relative;
}

/* Style Leaflet attribution: no background, grey italic text */
.leaflet-control-attribution,
.leaflet-control-attribution a {
    background: none !important;
    color: #888 !important;
    font-style: italic !important;
    font-family: Arial, sans-serif !important;
    font-size: 13px !important;
    border: none !important;
    box-shadow: none !important;
    text-decoration: none !important;
}
.leaflet-control-attribution a:hover {
    color: #555 !important;
    text-decoration: underline !important;
}

.welcome-screen {
    position: fixed;
    font-family: sans-serif;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    padding: 20px;
    box-sizing: border-box;
}

.welcome-screen.light-mode {
    background: rgba(0, 0, 0, 0.8) !important;
    color: white !important;
}

.welcome-logo {
    max-width: 300px;
    max-height: 150px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.welcome-title {
    font-size: 2.4em; 
    margin-bottom: 20px; 
    text-align: center;
}

.welcome-checkbox-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 1.1em;
}

.welcome-checkbox {
    transform: scale(1.7);
    cursor: pointer;
}

.welcome-checkbox-label {
    cursor: pointer;
    user-select: none;
    font-size: 1.45em;
}

.welcome-content-box {
    width: 155rem;
    height: 67rem;
    text-align: justify;
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 25px;
    background: rgba(255, 255, 255, 0.1);
    padding: 25px;
    border-radius: 10px;
    backdrop-filter: blur(10px);
    overflow-y: auto; /* Add vertical scrollbar when needed */
    box-sizing: border-box; /* Include padding in height calculation */
}
.welcome-button {
    padding: 12px 30px;
    font-size: 1.5em;
    background-color: #6c757d;
    color: white;
    font-family: sans-serif;
    border: none;
    border-radius: 8px;
    cursor: not-allowed;
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    transition: background-color 0.3s, transform 0.2s, cursor 0.3s;
    opacity: 0.6;
}

/* Add dark/light mode toggle styles */
.theme-toggle {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.1);  /* <-- Change this for light mode button background */
    border: 1px solid rgba(0, 0, 0, 0.2);  /* <-- Change this for light mode button border */
    border-radius: 8px;
    padding: 10px 16px;
    color: white;
    font-family: sans-serif;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    gap: 8px;
}

.theme-toggle:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.welcome-screen.light-mode .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

/* Light mode styles for welcome screen */
.welcome-screen.light-mode {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
}

.welcome-screen.light-mode .welcome-content-box {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #333 !important;
}

.welcome-screen.light-mode .theme-toggle {
    background: rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(0, 0, 0, 0.2);
    color: #ffffff;
}

.welcome-screen.light-mode h3 {
    color: #2563eb !important;
}

#task-counter {
    position: fixed;
    left: 50%;
    bottom: 20px;
    transform: translateX(-50%) scale(1.23);
    z-index: 30000;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.13);
    padding: 14px 32px;
    font-family: Arial, sans-serif;
    font-size: 1.18em;
    color: #c0392b;
    font-weight: 600;
    border: 2px solid #c0392b;
    display: none;
    transition: color 0.3s, border-color 0.3s, background 0.3s;
    text-align: center;
}

/* Prevent info markers from scaling with page scaling */
.info-marker-icon {
    transform-origin: center !important;
    transform: scale(calc(1 / var(--scale-factor, 1))) !important;
}

.font-size-control {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 50000; /* Very high z-index to stay above everything */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: flex !important; /* Force display */
    flex-direction: row; /* Changed from column to row */
    align-items: center; /* Center items vertically */
    gap: 12px; /* Horizontal gap between items */
    backdrop-filter: blur(5px);
    font-family: Arial, sans-serif;
}

.font-size-control button {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px; /* Reduced padding for horizontal layout */
    font-size: 26px; /* Slightly smaller font */
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    min-width: 80px; /* Reduced width */
    height: 36px; /* Reduced height */
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Arial, sans-serif;
    white-space: nowrap; /* Prevent text wrapping */
}

.font-size-control button:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.font-size-control button:active {
    transform: translateY(0);
}

.font-size-control button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.font-size-label {
    font-size: 26px; /* Smaller font size */
    color: #333;
    text-align: center;
    margin: 0; /* Remove margins */
    font-weight: 600;
    font-family: Arial, sans-serif;
    letter-spacing: 0.3px;
    white-space: nowrap; /* Prevent text wrapping */
}

/* Apply font size to text elements - INCLUDING carousel overlay */
.font-size-SS .welcome-content-box,
.font-size-SS #carousel-overlay {
    font-size: 0.9em !important;
}

.font-size-S .welcome-content-box,
.font-size-S #carousel-overlay {
    font-size: 0.95em !important;
}

.font-size-L .welcome-content-box,
.font-size-L #carousel-overlay {
    font-size: 1.05em !important;
}

.font-size-XL .welcome-content-box,
.font-size-XL #carousel-overlay {
    font-size: 1.1em !important;
}

.font-size-XXL .welcome-content-box,
.font-size-XXL #carousel-overlay {
    font-size: 1.15em !important;
}

.font-size-XXXL .welcome-content-box,
.font-size-XXXL #carousel-overlay {
    font-size: 1.2em !important;
}
.font-size-XXXXL .welcome-content-box,
.font-size-XXXXL #carousel-overlay {
    font-size: 1.25em !important;
}


/* Overlay scaling by font size */
.font-size-SS .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 0.7)) !important; }
.font-size-S  .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 0.8)) !important; }
.font-size-L  .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 1.1)) !important; }
.font-size-XL .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 1.2)) !important; }
.font-size-XXL .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 1.3)) !important; }
.font-size-XXXL .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 1.4)) !important; }
.font-size-XXXXL .overlay { transform: translate(-50%, -50%) scale(calc(1.5 * 1.5)) !important; }

/* Carousel container scaling by font size */
.font-size-SS .carousel-container { transform: scale(calc(1.5 * 0.8)) !important; }
.font-size-S  .carousel-container { transform: scale(calc(1.5 * 0.9)) !important; }
.font-size-L  .carousel-container { transform: scale(calc(1.5 * 1.1)) !important; }
.font-size-XL .carousel-container { transform: scale(calc(1.5 * 1.2)) !important; }
.font-size-XXL .carousel-container { transform: scale(calc(1.5 * 1.3)) !important; }
.font-size-XXXL .carousel-container { transform: scale(calc(1.5 * 1.4)) !important; }
.font-size-XXXXL .carousel-container { transform: scale(calc(1.5 * 1.5)) !important; }

#task-counter {
    --tc-scale: 1.23;                /* baseline scale (N) */
    transform: translateX(-50%) scale(var(--tc-scale));
    transform-origin: center bottom; /* anchor bottom so growth is upward */
}

/* Only change the custom property; NEVER replace transform */
#task-counter.task-font-size-SS { --tc-scale: calc(1.23 * 0.80); }
#task-counter.task-font-size-S  { --tc-scale: calc(1.23 * 0.90); }
#task-counter.task-font-size-N  { --tc-scale: 1.23; }
#task-counter.task-font-size-L  { --tc-scale: calc(1.23 * 1.10); }
#task-counter.task-font-size-XL { --tc-scale: calc(1.23 * 1.20); }
#task-counter.task-font-size-XXL{ --tc-scale: calc(1.23 * 1.30); }
#task-counter.task-font-size-XXXL{ --tc-scale: calc(1.23 * 1.40); }
#task-counter.task-font-size-XXXXL{ --tc-scale: calc(1.23 * 1.50); }

.font-size-control-2 {
    position: fixed;
    bottom: 100px;
    left: 20px;
    z-index: 50000;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    flex-direction: row;
    align-items: center;
    gap: 12px;
    backdrop-filter: blur(5px);
    font-family: Arial, sans-serif;
}

.font-size-control-2 button {
    background: #c0392b;;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 26px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    min-width: 80px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Arial, sans-serif;
    white-space: nowrap;
}

.font-size-control-2 button:hover {
    background: #641212;
    transform: translateY(-1px);
}

.font-size-control-2 button:active {
    transform: translateY(0);
}

.font-size-control-2 button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.font-size-control-2 .font-size-label {
    font-size: 26px;
    color: #333;
    text-align: center;
    margin: 0;
    font-weight: 600;
    font-family: Arial, sans-serif;
    letter-spacing: 0.3px;
    white-space: nowrap;
}

.form-redirect-card {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.28);
    padding: 40px 60px;
    text-align: center;
    max-width: 90vw;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    font-family: Arial, sans-serif;
    transform: scale(1);
    transform-origin: center center;
    transition: transform 0.45s cubic-bezier(.4,2,.6,1), font-size 0.3s ease;
}

/* Optional inner element refinements */
.form-redirect-card h2 {
    margin-top: 0;
    margin-bottom: 22px;
    font-size: 2.2em;
    color: #2563eb;
    font-family: inherit;
}
.form-redirect-card p {
    font-size: 1.15em;
    line-height: 1.45;
    color: #222;
    margin: 0 0 28px 0;
    font-family: inherit;
}

/* Scale with primary zoom (mirrors your overlay / carousel logic proportions) */
.font-size-SS #form-redirect-overlay .form-redirect-card { transform: scale(0.85); }
.font-size-S  #form-redirect-overlay .form-redirect-card { transform: scale(0.90); }
/* Normal (N) = 1.00 */
.font-size-L  #form-redirect-overlay .form-redirect-card { transform: scale(1.10); }
.font-size-XL #form-redirect-overlay .form-redirect-card { transform: scale(1.20); }
.font-size-XXL #form-redirect-overlay .form-redirect-card { transform: scale(1.30); }
.font-size-XXXL #form-redirect-overlay .form-redirect-card { transform: scale(1.40); }
.font-size-XXXXL #form-redirect-overlay .form-redirect-card { transform: scale(1.50); }

        </style>
        <title></title>
    </head>
    <body>
                
<!-- Welcome Screen -->
<div id="welcome-screen" class="welcome-screen">
    
    <!-- Add image at the top/center -->
    <img src="images/EMP.png" alt="Welcome Logo" class="welcome-logo">
    
    <h1 class="welcome-title">Welcome!</h1>
    
    <div class="welcome-content-box">

            
        <h3 style="color: #87CEEB; margin: 20px 0 10px 0; font-size: 2em;">About This Study</h3>
        <p style="margin-bottom: 15px;font-size: 1.6em">
            This Web Map application has been developed as part of a Master's Thesis for the MSc in Geoinformatics at the National Technical University of Athens.
        </p>
        
        <p style="margin-bottom: 15px;font-size: 1.6em">
            The purpose of this research is to explore how different multimedia formats—text, audio, images, video, 3D models, and QR codes—affect usability and cognitive load in digital map-based environments.
        </p>
        
        <p style="margin-bottom: 15px;font-size: 1.6em">
            You will be asked to complete 10 short tasks by interacting with the interface. Afterward, you will be directed to a questionnaire to share your experience.
        </p>
        
        <h3 style="color: #87CEEB; margin: 20px 0 10px 0; font-size: 2.2em;">Important Notice</h3>
        <h3 style="color: #ffffff; margin: 20px 0 10px 0; font-size: 1.8em;">For the purposes of personal data protection, and in accordance with the European General Data Protection Regulation, please note that:</h3>
        
        <ul style="margin: 0; padding-left: 20px; list-style-type: disc; font-size: 1.6em;">
            <li style="margin-bottom: 8px;">The survey is completely anonymous and under no circumstances can participants be identified.</li>
            <li style="margin-bottom: 8px;">You may stop completing the questionnaire at any time without any of your data being recorded.</li>
            <li style="margin-bottom: 8px;">All collected information will remain strictly confidential and anonymous.</li>
            <li style="margin-bottom: 8px;">The database will be password-protected and inaccessible to individuals outside the research team.</li>
            <li style="margin-bottom: 8px;">Statistical analysis will be coded and anonymous.</li>
        </ul>
        <h3 style="color: #87CEEB; margin: 20px 0 10px 0; font-size: 2.2em;">Before you begin</h3>
        <div style="margin-bottom: 8px;font-size: 1.8em;">You will need access to:</div>
        <ul style="margin-top: 5px; padding-left: 20px; font-size: 1.6em;">
            <li style="margin-bottom: 5px;">A PC or laptop to run the Web Map application</li>
            <li style="margin-bottom: 5px;">Chrome or Edge Browser(or any other Chromium-based internet browser)</li>
            <li style="margin-bottom: 5px;">A mobile phone with QR-scanning capability.</li>
            <li style="margin-bottom: 8px;">Running the Web Map application on mobile devices is not natively supported and may cause issues.</li>
            <li style="margin-bottom: 8px;">The entire process should take approximately <b>15–20 minutes.</b></li>
        </ul>
    </div>

    <!-- Checkbox for instructions confirmation -->
    <div class="welcome-checkbox-container">
        <input type="checkbox" id="welcome-instructions-checkbox" class="welcome-checkbox">
        <label for="welcome-instructions-checkbox" class="welcome-checkbox-label">
            By pressing "Proceed" you certify that you are at least 18 years old and that you give your consent to participate in this research.
        </label>
    </div>
    
<button id="welcome-button" class="welcome-button" disabled>
    Proceed
</button>

<!-- Theme Toggle Button -->
<button id="theme-toggle" class="theme-toggle">
    <span class="theme-toggle-icon">☀️</span>
    <span class="theme-toggle-text">Light Mode</span>
</button>
</div>



<!-- Overlay HTML -->
<div id="monument-overlay" class="overlay" style="display:none;">
    <span class="close-button" onclick="closeMonumentOverlay()">&times;</span>
    <div style="display: flex; flex: 1 1 0; min-height: 0; height: 100%;">
<!-- Vertical Tabs -->
<div class="vertical-tabs">
    <button class="tab-btn active" data-tab="info">Info</button>
    <button class="tab-btn" data-tab="desc">Description</button>
    <button class="tab-btn" data-tab="img">Image</button>
    <button class="tab-btn" data-tab="audio">Audio</button>
    <button class="tab-btn" data-tab="video">Video</button> <!-- 🟢 Add this line -->
    <button class="tab-btn" data-tab="model">3D Model</button>
    <button class="tab-btn" data-tab="qr">QR Code</button>
</div>
<!-- Tab Content -->
    <div class="tab-content" id="tab-info"></div>
    <div class="tab-content" id="tab-desc" style="display:none;"></div>
    <div class="tab-content" id="tab-img" style="display:none;"></div>
    <div class="tab-content" id="tab-audio" style="display:none;"></div>
    <div class="tab-content" id="tab-video" style="display:none;"></div> <!-- 🟢 Add this line -->
    <div class="tab-content" id="tab-model" style="display:none;"></div>
    <div class="tab-content" id="tab-qr" style="display:none;"></div>
</div>
    </div>
</div>

<!-- 1. Add EmailJS SDK in <head> -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<div id="form-redirect-overlay">
    <div class="form-redirect-card">
        <h2>Congratulations!</h2>
        <p>
            You have successfully completed all tasks.<br>
            Please click the button below to proceed to the questionnaire.
        </p>
        <button id="open-form-btn" class="modern-3d-button" style="font-size:1.1em; padding:12px 32px;">
            Proceed to Questionnaire
        </button>
    </div>
</div>

<!-- Add the font size control HTML after the map div -->
<div id="font-size-control" class="font-size-control">
    <div class="font-size-label">UI and Font Size</div>
    <button id="font-increase" title="Increase font size">+</button>
    <button id="font-decrease" title="Decrease font size">-</button><br>
    <button id="font-reset" title="Reset to normal size">Default</button>
</div>

<!-- Add this HTML after the existing font-size-control div -->
<div id="font-size-control-2" class="font-size-control-2" style="display: none;">
    <div class="font-size-label">Taskbar Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>
    <button id="font-increase-2" title="Increase font size">+</button>
    <button id="font-decrease-2" title="Decrease font size">-</button><br>
    <button id="font-reset-2" title="Reset to normal size">Default</button>
</div>

<!-- Carousel Overlay (hidden by default) -->
<div id="carousel-overlay">
    <div class="carousel-container">
        <div id="carousel-slides"></div>
        <div id="carousel-checkbox-row">
            <input type="checkbox" id="carousel-agree-checkbox" style="transform: scale(1.3);" />
            <label for="carousel-agree-checkbox" style="font-size: 1.08em; color: #222; cursor: pointer;">
                I have read and understood the application's usage instructions.
            </label>
        </div>
        <div class="carousel-controls-row">
            <button id="carousel-prev" class="modern-3d-button" style="min-width:80px;">Previous</button>
            <button id="carousel-next" class="modern-3d-button" style="min-width:80px;">Next</button>
        </div>
        <div id="carousel-dots"></div>
    </div>
</div>

<div id="task-counter">
    <span id="task-counter-text"></span>
    <br>
    <button id="task-continue-btn" class="modern-3d-button" style="display:none;margin-top:12px;">Submit</button>
</div>

<!-- Blurred Background -->
<div id="blur-overlay" class="blur-overlay"></div>
</div>

        <div id="map"></div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="data/Monuments_3.js"></script>
        <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
        <script>

(function() {
    const referenceWidth = 2800;   // base design width
    const referenceHeight = 1540;  // base design height

    function applyScaling() {
        const scaleX = window.innerWidth / referenceWidth;
        const scaleY = window.innerHeight / referenceHeight;

        // Keep proportions, fit to smaller dimension
        const scale = Math.min(scaleX, scaleY);

        const html = document.documentElement;
        
        // Only apply scaling if the viewport is smaller than reference
        // This allows browser zoom to work naturally on larger screens
        if (scale < 1) {
            // Apply scaling
            html.style.transform = `scale(${scale})`;
            html.style.transformOrigin = 'top left';
            
            // Prevent clipping
            html.style.width = `${100 / scale}%`;
            html.style.height = `${100 / scale}vh`;
            html.style.overflow = 'hidden';
        } else {
            // Reset scaling for larger viewports
            html.style.transform = '';
            html.style.transformOrigin = '';
            html.style.width = '';
            html.style.height = '';
            html.style.overflow = '';
        }
        
        // Set a CSS custom property for scale factor that other elements can use
        html.style.setProperty('--scale-factor', scale < 1 ? scale : 1);
        
        // Force a repaint to ensure all elements are updated
        html.offsetHeight;
    }

    // Initial scaling
    applyScaling();
    
    // Reapply scaling on window resize with debouncing
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(applyScaling, 100);
    });

    // Handle browser zoom changes
    let lastZoom = window.devicePixelRatio;
    function checkZoom() {
        const currentZoom = window.devicePixelRatio;
        if (Math.abs(currentZoom - lastZoom) > 0.1) {
            lastZoom = currentZoom;
            applyScaling();
        }
    }
    
    // Check for zoom changes periodically
    setInterval(checkZoom, 500);
    
    // Also listen for visual viewport changes (modern browsers)
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', applyScaling);
    }
})();

(function() {
    const sizes = ['SS','S','N','L','XL','XXL','XXXL','XXXXL'];
    let idx = 2; // Normal
    const inc = document.getElementById('font-increase');
    const dec = document.getElementById('font-decrease');
    const rst = document.getElementById('font-reset');

    function apply() {
        sizes.forEach(s => document.body.classList.remove('font-size-' + s));
        document.body.classList.add('font-size-' + sizes[idx]);
        updateButtons();
    }
    function clamp(v) { return Math.max(0, Math.min(sizes.length - 1, v)); }
    function updateButtons() {
        if (!inc || !dec || !rst) return;
        inc.disabled = idx === sizes.length - 1;
        dec.disabled = idx === 0;
        rst.disabled = idx === 2;
    }

    inc && inc.addEventListener('click', () => { idx = clamp(idx + 1); apply(); });
    dec && dec.addEventListener('click', () => { idx = clamp(idx - 1); apply(); });
    rst && rst.addEventListener('click', () => { idx = 2; apply(); });

    apply();
})();

(function() {
    const sizes = ['SS','S','N','L','XL','XXL','XXXL','XXXXL'];
    let idx = 2;
    const inc = document.getElementById('font-increase-2');
    const dec = document.getElementById('font-decrease-2');
    const rst = document.getElementById('font-reset-2');

    function apply() {
        const tc = document.getElementById('task-counter');
        if (!tc) return;
        sizes.forEach(s => tc.classList.remove('task-font-size-' + s));
        tc.classList.add('task-font-size-' + sizes[idx]);
        updateButtons();
    }
    function clamp(v) { return Math.max(0, Math.min(sizes.length - 1, v)); }
    function updateButtons() {
        if (!inc || !dec || !rst) return;
        inc.disabled = idx === sizes.length - 1;
        dec.disabled = idx === 0;
        rst.disabled = idx === 2;
    }

    inc && inc.addEventListener('click', () => { idx = clamp(idx + 1); apply(); });
    dec && dec.addEventListener('click', () => { idx = clamp(idx - 1); apply(); });
    rst && rst.addEventListener('click', () => { idx = 2; apply(); });

    apply(); // Safe even while hidden
})();

/* ==== Theme Toggle (unchanged behavior) ==== */
document.getElementById('theme-toggle').addEventListener('click', function() {
    const welcome = document.getElementById('welcome-screen');
    const icon = document.querySelector('.theme-toggle-icon');
    const text = document.querySelector('.theme-toggle-text');
    const light = welcome.classList.toggle('light-mode');
    if (light) {
        icon.textContent = '🌙';
        text.textContent = 'Dark Mode';
    } else {
        icon.textContent = '☀️';
        text.textContent = 'Light Mode';
    }
});

// Add this helper (place before function showTaskCounter or anywhere above its first use)
function addEnterSubmit(inputEl, buttonEl) {
    if (!inputEl || !buttonEl) return;
    inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (!buttonEl.disabled) buttonEl.click();
        }
    });
}

/* ==== Start Experience Helper (shows secondary control & task counter) ==== */
(function() {
    let started = false;
    function startExperience() {
        if (started) return;
        started = true;
        const ctrl2 = document.getElementById('font-size-control-2');
        if (ctrl2) ctrl2.style.display = 'flex';
        if (typeof showTaskCounter === 'function') showTaskCounter();
    }
    window._startExperience = startExperience;

    // Attach a capturing listener so later .onclick overwrites do NOT block this
    const nextBtn = document.getElementById('carousel-next');
    if (nextBtn) {
        nextBtn.addEventListener('click', function() {
            // We rely on later logic changing text to "Start" on final slide
            setTimeout(() => {
                const overlay = document.getElementById('carousel-overlay');
                if (nextBtn.textContent.trim().toLowerCase() === 'start' &&
                    overlay && overlay.style.display === 'none') {
                    startExperience();
                }
            }, 550); // Slightly longer than overlay fade (500ms)
        }, true);
    }

    // Fallback: when overlay transitions to display:none (any path)
    const overlay = document.getElementById('carousel-overlay');
    if (overlay) {
        const mo = new MutationObserver(() => {
            if (!started && overlay.style.display === 'none') {
                startExperience();
            }
        });
        mo.observe(overlay, { attributes: true, attributeFilter: ['style','class'] });
    }
})();

/* ==== Revised Initial Carousel Button Listeners (non-conflicting) ==== */
/* DO NOT overwrite later logic for validation and slide rendering.
   We only add a guard to avoid accidental duplicate binding.
*/
(function() {
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    if (prevBtn && !prevBtn.dataset.initPrimary) {
        prevBtn.dataset.initPrimary = '1';
        // Leave actual navigation to later code; no-op placeholder.
    }
    if (nextBtn && !nextBtn.dataset.initPrimary) {
        nextBtn.dataset.initPrimary = '1';
        // Navigation handled in later renderCarouselSlides logic.
    }
})();

/* ==== Welcome Checkbox Enable/Disable ==== */
document.getElementById('welcome-instructions-checkbox').addEventListener('change', function() {
    const btn = document.getElementById('welcome-button');
    if (this.checked) {
        btn.disabled = false;
        btn.style.backgroundColor = '#007bff';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
        btn.style.boxShadow = '0 4px 15px rgba(0,123,255,0.3)';
        btn.onmouseover = function() {
            this.style.backgroundColor = '#0056b3';
            this.style.transform = 'translateY(-2px)';
        };
        btn.onmouseout = function() {
            this.style.backgroundColor = '#007bff';
            this.style.transform = 'translateY(0)';
        };
    } else {
        btn.disabled = true;
        btn.style.backgroundColor = '#6c757d';
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.6';
        btn.style.boxShadow = '0 4px 15px rgba(108,117,125,0.3)';
        btn.style.transform = 'translateY(0)';
        btn.onmouseover = null;
        btn.onmouseout = null;
    }
});

        // Function to hide the welcome screen when the button is clicked
document.getElementById('welcome-button').addEventListener('click', function () {
    const welcomeScreen = document.getElementById('welcome-screen');
    welcomeScreen.style.transition = 'opacity 0.5s';
    welcomeScreen.style.opacity = '0';
    setTimeout(() => {
        welcomeScreen.style.display = 'none';
        startTaskTimer(1); // <-- Start the timer for Task 1 here!
    }, 500);
});

        // 🟢 MAP INITIALIZATION
var map = L.map('map', {
    zoomControl: false,
    maxZoom: 28,
    minZoom: 5,
    maxBounds: [[-85, -Infinity], [85, Infinity]], // Only restrict latitude (north/south)
    maxBoundsViscosity: 1.0, // Make vertical bounds firm
    worldCopyJump: true // Enable horizontal world wrapping
}).setView([46.944, 20.654], 5); // [lat, lng], zoom
        map.attributionControl.setPrefix('<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // 🟢 POPUP UTILITIES
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        // 🟢 MAP CONTROLS
        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

        // 🟢 BASEMAPS
        var bounds_group = new L.featureGroup([]);
        function setBounds() {}
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.createPane('pane_GoogleSatellite_1');
        map.getPane('pane_GoogleSatellite_1').style.zIndex = 401;
        var layer_GoogleSatellite_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatellite_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 22
        });
        layer_GoogleSatellite_1;
        map.createPane('pane_CartoDark_2');
        map.getPane('pane_CartoDark_2').style.zIndex = 402;
        var layer_CartoDark_2 = L.tileLayer('https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}@2x.png', {
            pane: 'pane_CartoDark_2',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 18
        });
        layer_CartoDark_2;
        map.addLayer(layer_CartoDark_2);

        // 🟢 BASEMAP CONTROL (top right)
            var baseMaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Google Satellite": layer_GoogleSatellite_1,
            "Carto Dark": layer_CartoDark_2
            };
            L.control.layers({ "Carto Dark": layer_CartoDark_2, "OpenStreetMap": layer_OpenStreetMap_0, "Google Satellite": layer_GoogleSatellite_1 }).addTo(map);

            // Listen for basemap change to complete Task 4
map.on('baselayerchange', function(e) {
    if (window._task4Active && !window._task4Completed) {
        window._task4Completed = true;
        if (typeof tasks !== "undefined" && tasks[3] && tasks[3].check && currentTask === 3 && tasks[3].check()) {
            completeCurrentTask();
        }
    }
});
        // Add a "Basemaps" header to the basemap selector panel
        setTimeout(function() {
            var list = document.querySelector('.leaflet-control-layers-base');
            if (list && !list.querySelector('.custom-basemap-header')) {
                var header = document.createElement('div');
                header.textContent = 'Basemaps';
                header.className = 'custom-basemap-header';
                list.insertBefore(header, list.firstChild);
            }
        }, 300);

// 🟢 MONUMENTS LAYER AND POPUP
function pop_Monuments_3(feature, layer) {
    // ...inside pop_Monuments_3...
layer.on('click', function(e) {
    showMonumentInfoOverlay(feature);

    // Ensure overlay audio interrupts hover sound
setTimeout(() => {
    const overlayAudio = document.querySelector('#tab-audio audio');
    if (overlayAudio) {
        overlayAudio.addEventListener('play', function() {
            if (window._monumentAudio && !window._monumentAudio.paused) {
                window._monumentAudio.pause();
                window._monumentAudio.currentTime = 0;
            }
        });
    }
}, 0);
});}

//Play sound when hovering over monuments

function playMonumentSound(src) {
    if (window._monumentAudio) {
        window._monumentAudio.pause();
        window._monumentAudio.currentTime = 0;
    }
    window._monumentAudio = new Audio(src);
    window._monumentAudio.play();
}

        // 🟢 MONUMENTS LAYER
var infoIcon = L.icon({
    iconUrl: 'markers/info.png',
    iconSize: [20, 20],
    iconAnchor: [8, 16],    // Center bottom
    popupAnchor: [0, -16]
});

var layer_Monuments_3 = new L.geoJson(json_Monuments_3, {
    attribution: '',
    interactive: true,
    dataVar: 'json_Monuments_3',
    layerName: 'layer_Monuments_3',
    pane: 'pane_Monuments_3',
    onEachFeature: pop_Monuments_3, // <-- Add this line
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: infoIcon });
    }
});
        bounds_group.addLayer(layer_Monuments_3);

// Add a variable to track the last played monument
window._lastMonumentName = null;

function playMonumentSound(src, monumentName) {
    // Only interrupt if a different monument is hovered
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;
    }
    // If the same monument, do nothing (let the sound continue)
}

// Helper: Check if any popup audio is playing
function isPopupAudioPlaying() {
    const audios = document.querySelectorAll('.leaflet-popup .audio');
    for (let audio of audios) {
        if (!audio.paused && !audio.ended) {
            return true;
        }
    }
    return false;
}

// Listen for play events on popup audio to stop hover audio
document.addEventListener('play', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        // Stop hover audio if playing
        if (window._monumentAudio && !window._monumentAudio.paused) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
    }
}, true);

// Listen for pause and ended events on popup audio to allow replay of hover audio
document.addEventListener('pause', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        window._lastMonumentName = null;
    }
}, true);

document.addEventListener('ended', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        window._lastMonumentName = null;
    }
}, true);

// Update playMonumentSound to respect popup audio
function playMonumentSound(src, monumentName) {
    if (isPopupAudioPlaying()) {
        return;
    }
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;

        // When hover audio ends, allow replay on next hover
        window._monumentAudio.onended = function() {
            window._lastMonumentName = null;
        };
    }
}

// Update playMonumentSound to allow replay after audio ends
function playMonumentSound(src, monumentName) {
    if (isPopupAudioPlaying()) {
        return;
    }
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;

        // When hover audio ends, allow replay on next hover
        window._monumentAudio.onended = function() {
            window._lastMonumentName = null;
        };
    }
}

layer_Monuments_3.eachLayer(function(marker) {
    marker.on('mouseover', function(e) {
        var icon = e.target._icon;
        if (icon) {
            icon.style.transition = 'width 0.2s, height 0.2s';
            icon.style.width = '30px';
            icon.style.height = '30px';
            icon.style.zIndex = 1001;
        }
        // Play sound based on Name attribute
        var feature = e.target.feature;
if (feature && feature.properties && feature.properties['Name']) {
    if (feature.properties['Name'] === 'Big Ben') {
        playMonumentSound('sounds/LondonHover.mp3', 'Big Ben');
    } else if (feature.properties['Name'] === 'Brandenburg Gate') {
        playMonumentSound('sounds/BerlinHover.mp3', 'Brandenburg Gate');
    } else if (feature.properties['Name'] === 'Colosseum') {
        playMonumentSound('sounds/RomeHover.mp3', 'Colosseum');
    } else if (feature.properties['Name'] === 'Eiffel Tower') {
        playMonumentSound('sounds/ParisHover.mp3', 'Eiffel Tower');
    } else if (feature.properties['Name'] === 'The Parthenon') {
        playMonumentSound('sounds/AthensHover.mp3', 'The Parthenon');
    } else if (feature.properties['Name'] === 'Leaning Tower of Pisa') {
        playMonumentSound('sounds/PisaHover.mp3', 'Leaning Tower of Pisa');
    } else if (feature.properties['Name'] === 'White Tower of Thessaloniki') {
        playMonumentSound('sounds/ThessalonikiHover.mp3', 'White Tower of Thessaloniki');
    } else if (feature.properties['Name'] === 'Hagia Sophia') {
        playMonumentSound('sounds/IstanbulHover.mp3', 'Hagia Sophia');
    } else if (feature.properties['Name'] === 'Edinburgh Castle') {
        playMonumentSound('sounds/ScotlandHover.mp3', 'Edinburgh Castle');
    } else if (feature.properties['Name'] === 'St. Basil\'s Cathedral') {
        playMonumentSound('sounds/RussiaHover.mp3', 'St. Basil\'s Cathedral');
    } else if (feature.properties['Name'] === 'The Atomium') { // 🟢 Add this line for Atomium
        playMonumentSound('sounds/AtomiumHover.mp3', 'The Atomium');
    }
}
    });
    marker.on('mouseout', function(e) {
        var icon = e.target._icon;
        if (icon) {
            icon.style.width = '20px';
            icon.style.height = '20px';
            icon.style.zIndex = '';
        }
        // Do NOT stop the sound here anymore!
    });
    map.addLayer(layer_Monuments_3);
});
// Overlay tab logic
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const tab = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc => {
            tc.classList.remove('active');
            tc.style.display = 'none';
        });
        const activeTab = document.getElementById('tab-' + tab);
        activeTab.classList.add('active');
        activeTab.style.display = 'flex';
    });
});

function closeMonumentOverlay() {
    const overlay = document.getElementById('monument-overlay');
    const blur = document.getElementById('blur-overlay');
        const now = Date.now();
    if (currentTab && tabLastEnterTime[currentTab] !== null) {
        tabTotalTimes[currentTab] += (now - tabLastEnterTime[currentTab]) / 1000;
        tabLastEnterTime[currentTab] = null;
    }
    currentTab = null;
    overlay.classList.remove('open');
    blur.style.opacity = 0;
    setTimeout(() => {
        overlay.style.display = 'none';
        blur.style.display = 'none';
    }, 500);
}

// Close overlay when clicking outside the overlay (on blur-overlay)
document.getElementById('blur-overlay').addEventListener('click', closeMonumentOverlay);

// Close overlay when pressing Escape
document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') closeMonumentOverlay();
});


function showMonumentInfoOverlay(feature) {
    window._lastMonumentNameClicked = feature.properties.Name; // <-- Add this line at the top

    // --- Mappings (same as index3 - Copy.html) ---
    const imageMap = { 0: 'images/BIGBEN.jpg', 1: 'images/GATE.png', 2: 'images/ROME.jpg', 3: 'images/PARIS.png', 4: 'images/PARTHENON.jpg', 5: 'images/PISA.jpg', 6: 'images/THESSALONIKI.jpg', 7: 'images/ISTANBUL.jpg', 8: 'images/EDINBURGH2.jpg', 9: 'images/STBASIL.jpg', 10: 'images/ATOMIUM.jpg' }; // 🟢 Add Atomium image
    const audioImgMap = {
        0: 'images/LondonRadio.png',
        1: 'images/BerlinRadio.png',
        2: 'images/ColosseumRadio.png',
        3: 'images/ParisRadio.png',
        4: 'images/AthensRadio.png',
        5: 'images/PisaRadio.png',
        6: 'images/ThessalonikiRadio.png',
        7: 'images/IstanbulRadio.png',
        8: 'images/ScotlandRadio.png',
        9: 'images/RussiaRadio.png',
        10: 'images/AtomiumRadio.png' // 🟢 Add this line for Atomium
    };
    const audioSrcMap = {
        0: 'sounds/LondonAudioGuide.mp3',
        1: 'sounds/BerlinAudioGuide.mp3',
        2: 'sounds/RomeAudioGuide.mp3',
        3: 'sounds/ParisAudioGuide.mp3',
        4: 'sounds/TheParthenonAudioGuide.mp3',
        5: 'sounds/PisaAudioGuide.mp3',
        6: 'sounds/ThessalonikiAudioGuide.mp3',
        7: 'sounds/IstanbulAudioGuide.mp3',
        8: 'sounds/ScotlandAudioGuide.mp3',
        9: 'sounds/RussiaAudioGuide.mp3',
        10: 'sounds/AtomiumAudioGuide.mp3' // 🟢 Add this line for Atomium
    };

const videoMap = { // Updated with YouTube embed URLs
    0: 'https://www.youtube.com/embed/I6VVSr64jq4',
    1: 'https://www.youtube.com/embed/0aR1UeO5gTc',
    2: 'https://www.youtube.com/embed/lQ0B5rO3DSI',
    3: 'https://www.youtube.com/embed/mmaltWl5zY4',
    4: 'https://www.youtube.com/embed/_ZxMdg61h64',
    5: 'https://www.youtube.com/embed/Oumwp7Ln5Qk',
    6: 'https://www.youtube.com/embed/OeVXPHldaF4',
    7: 'https://www.youtube.com/embed/7jYkCz7weCU',
    8: 'https://www.youtube.com/embed/zqsCNDgWpUE',
    9: 'https://www.youtube.com/embed/ASpK2gu2Xr8',
    10: 'https://www.youtube.com/embed/20nv5cXCc-4'
};

const modelMap = {
    0: 'glb-london',
    1: 'sketchfab-berlin',
    2: 'sketchfab-rome',
    3: 'glb-paris',
    4: 'glb-athens',
    5: 'glb-pisa',
    6: 'glb-thessaloniki',
    7: 'glb-istanbul',
    8: 'sketchfab-edinburgh', // Edinburgh Castle (already Sketchfab)
    9: 'glb-russia',
    10: 'glb-atomium'
};

const glbUrls = {
    'glb-london': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/LONDON1.glb',
    'glb-russia': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/RUSSIA.glb',
    'glb-atomium': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ATOMIUM.glb',
    'glb-pisa': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/PISA.glb',
    'glb-thessaloniki': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/THESSALONIKI.glb',
    'glb-athens': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/PARTHENON.glb',
    'glb-istanbul': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ISTANBUL.glb',
    'glb-paris': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/PARIS.glb',
    'sketchfab-berlin': 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/BERLIN.glb',

    // Add more .glb models as needed
};

// Map each key to its Sketchfab embed URL
const sketchfabUrls = {
    'sketchfab-london': '',
    'sketchfab-berlin': '',
    'sketchfab-rome': 'https://sketchfab.com/models/58498d764d0f45af82d9cdfb4e27d59d/embed?autostart=1&camera=0&annotations_visible=0&transparent=1&ui_animations=0&ui_infos=0&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_hint=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0',
    'glb-paris': '',
    'glb-athens': '',
    'glb-pisa': '',
    'glb-thessaloniki': '',
    'sketchfab-edinburgh': 'https://sketchfab.com/models/b494fdf5e2754259bc90c536b18fcfff/embed?autostart=1&camera=0&annotations_visible=0&transparent=1&ui_animations=0&ui_infos=1&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_hint=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0', // Edinburgh Castle
    'sketchfab-russia': '',
    'sketchfab-atomium': '',
    'sketchfab-istanbul': ''
};


    const qrMap = { 0: 'images/LondonQR.png', 1: 'images/BerlinQR.png', 2: 'images/ColosseumQR.png', 3: 'images/ParisQR.png', 4: 'images/AthensQR.png', 5: 'images/PisaQR.png', 6: 'images/ThessalonikiQR.png', 7: 'images/IstanbulQR.png', 8: 'images/ScotlandQR.png', 9: 'images/RussiaQR.png', 10: 'images/AtomiumQR.png' };

const imageAttributions = {
    0: 'Photo by Mohamad T. for Big Ben. Under Unsplash License.',
    1: 'Photo by Pierre-Selim Huard for Brandenburg Gate.\nCC BY 4.0.',
    2: 'Photo by Spencer Davis for Colosseum. Under Unsplash License.',
    3: 'Photo by Benh LIEU SONG for Eiffel Tower.\nPublic Domain.',
    4: 'Photo by Spencer Davis for The Parthenon. Under Unsplash License..',
    5: 'Photo by Chiper Catalin-Marian for Colosseum. Under Pexels License.',
    6: 'Photo by Alexander Klink for The White Tower of Thessaloniki.\nCC BY-SA 3.0.',
    7: 'Photo by Adli Wahid for Hagia Sophia.\nCC BY-SA 3.0.',
    8: 'Photo by Kim Traynor for Edinburgh Castle.\nCC BY-SA 4.0.',
    9: 'Photo by Tsy1980 for Saint Basil\'s Cathedral.\nCC BY-SA 4.0.',
    10: 'Photo by Marek Śliwecki for The Atomium.\nCC BY-SA 4.0.'
};

// Add this attribution mapping
const modelAttributions = {
    'glb-london': 'Based on "Big Ben" by dolphkad\nCC BY 4.0, modified by Author',
    'sketchfab-berlin': 'Based on "Brandenburg Gate" by DylanF and "Quadriga" by Schiewo.\nCC BY 4.0, modified by Author.',
    'sketchfab-rome': 'Embedded from Sketchfab under Sketchfab License.\nAll rights remain with the original creator.',
    'glb-paris': 'Based on "Eiffel Tower" by Johnson Martin\nCC BY 4.0, modified by Author',
    'glb-athens': 'Based on "Parthenon" by edgaro\nCC BY 4.0, modified by Author',
    'glb-pisa': 'Based on "Pisa Tower" by aortagallery\nCC BY-NC 4.0, modified by Author',
    'glb-thessaloniki': 'White Tower\nModel Created by Author',
    'glb-istanbul': 'Based on "Hagia Sophia" by Ibišević\nCC BY 4.0, modified by Author',
    'sketchfab-edinburgh': 'Embedded from Sketchfab. Used under permission from Historic Environment Scotland\nAttribution Required. All rights remain with the original creator.',
    'glb-russia': 'Based on "St. Basil\'s" by Polskaball\nCC BY 4.0, modified by Author',
    'glb-atomium': 'Based on "Atomium" by Viddalm\nCC BY 4.0, modified by Author'
};

// ...existing code...
const videoAttributions = {
    0: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    1: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    2: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    3: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    4: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    5: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    6: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    7: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    8: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    9: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.',
    10: 'Embedded from YouTube under Standard YouTube License.\nAll rights remain with the original creator.'
};

const audioAttributions = {
    0: 'Audio Generated & Used under TTSMaker License.',
    1: 'Audio Generated & Used under TTSMaker License.',
    2: 'Audio Generated & Used under TTSMaker License.',
    3: 'Audio Generated & Used under TTSMaker License.',
    4: 'Audio Generated & Used under TTSMaker License.',
    5: 'Audio Generated & Used under TTSMaker License.',
    6: 'Audio Generated & Used under TTSMaker License.',
    7: 'Audio Generated & Used under TTSMaker License.',
    8: 'Audio Generated & Used under TTSMaker License.',
    9: 'Audio Generated & Used under TTSMaker License.',
    10: 'Audio Generated & Used under TTSMaker License.'
};

// --- Info Tab ---
const country = feature.properties.Country || '';
const city = feature.properties.City || '';
// Map country names to flag image filenames
const flagMap = {
    'Greece': 'GREECE.png',
    'England': 'UK.png',
    'Germany': 'GERMANY.jpg',
    'Italy': 'ITALY.png',
    'France': 'FRANCE.png',
    'Spain': 'SPAIN.png',
    'Turkey': 'TURKEY.jpg',
    'Scotland': 'SCOTLAND.jpg',
    'Russia': 'RUSSIA.png',
    'Belgium': 'BELGIUM.png',



    // Add more as needed
};
const flagFile = flagMap[country] ? `images/${flagMap[country]}` : '';
const flagImgHtml = flagFile
    ? `<br><img src="${flagFile}" alt="${country} flag" style="margin-top:24px;max-width:300px;max-height:225px;border-radius:7px;border:1px solid #ccc;">`
    : '';

document.getElementById('tab-info').innerHTML = `
    <div style="font-family: Arial, sans-serif;">
        <div style="font-weight: bold; font-size: 30px; margin-bottom: 30px;">
            ${feature.properties.Name || ''}
        </div>
        <div style="font-size: 20px; margin-bottom: 40px;">
            ${city}${city && country ? ', ' : ''}${country}
        </div>
        ${flagImgHtml}
    </div>
`;
document.getElementById('tab-info').style.fontFamily = "Arial, sans-serif";

// --- Description Tab (map number to text) ---
const descriptionMap = {
    0: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Big Ben</strong><br><br>
            Big Ben is the nickname for the Great Bell housed within the Elizabeth Tower at the north end of the Palace of Westminster in London. Though commonly used to refer to the entire structure, “Big Ben” originally referred only to the bell itself. The tower was completed in 1859 and renamed the Elizabeth Tower in 2012 to mark Queen Elizabeth II’s Diamond Jubilee.<br><br>
            Standing 96 meters tall, the tower was designed in the neo-Gothic style by Augustus Pugin, working with architect Charles Barry. Constructed from brick and clad in limestone, the tower features a cast iron spire and four large clock dials, each measuring seven meters in diameter. The clock’s minute hands are over four meters long, while the hour hands are shorter and made of gunmetal.<br><br>
            The Great Bell weighs approximately 13.5 tons and produces its iconic chime on the hour. It cracked shortly after being installed but was repaired by rotating it and fitting a lighter hammer, resulting in the distinctive tone still heard today. The tower also contains four smaller quarter bells, which chime every fifteen minutes.<br><br>
            The clock mechanism, designed by Edward John Dent, is known for its precision. Traditional penny coins are still used to regulate the pendulum. Despite wartime bombings and major renovations, the clock has remained a lasting symbol of British resilience and tradition.<br><br>
            Today, Big Ben continues to function as a working clock and a timekeeping symbol of Parliament. The chimes are used for ceremonial occasions, national events, and are broadcast live by the BBC, maintaining its role as a cultural and political icon.
        </div>`,
    1: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Brandenburg Gate</strong><br><br>
            The Brandenburg Gate is one of Berlin's most iconic landmarks, symbolizing both the tumultuous history and the unity of Germany. Completed in 1791, it was commissioned by King Frederick William II of Prussia and designed by Karl Gotthard Langhans.<br><br>
            The neoclassical monument stands at the western end of Unter den Linden and features 12 Doric columns, forming five passageways.<br><br>
            Topped by the Quadriga, a chariot drawn by four horses driven by the goddess of victory, it has witnessed many pivotal historical moments. During the Cold War, the gate stood in a no-man's land between East and West Berlin, becoming a symbol of division.<br><br>
            However, in 1989, when the Berlin Wall fell, it transformed into a powerful emblem of reunification. <br><br>
            Today, the Brandenburg Gate stands not only as a major tourist attraction but also as a national symbol of peace, unity and resilience. It continues to host national, cultural, political and several sports events and celebrations.
        </div>`,
    2: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Colosseum</strong><br><br>
            The Colosseum is an elliptical amphitheater in the center of the city of Rome, Italy, just east of the Roman Forum. Construction began under the Emperor Vespasian in 72 A.D. and was completed in 80 A.D. under his successor and heir, Titus. Further modifications were made during the reign of Domitian.<br><br>
            The three emperors who were patrons of the work are known as the Flavian dynasty, and originally the amphitheater was named the Flavian Amphitheater by later classicists and archaeologists for its association with their family name, Flavius.<br><br>
            The height of the Colosseum is 157 feet, or 48 meters, and the base area is 6 acres, or 24,000 square meters. This means that it is taller than a 16-story building and it has enough room for more than three football fields.<br><br>
            The Colosseum is built of travertine limestone, tough volcanic rock, and brick-faced concrete. It could hold an estimated fifty thousand to eighty thousand spectators at various points in its history, having an average audience of some sixty-five thousand. It was used for gladiatorial contests and public spectacles, including animal hunts, executions, reenactments of famous battles, dramas based on Roman mythology, and briefly mock sea battles.<br><br>
            The building ceased to be used for entertainment in the early medieval era. It was later reused for such purposes as housing, workshops, quarters for a religious order, a fortress, a quarry, and a Christian temple. Although substantially ruined by earthquakes and stone robbers taking spolia, the Colosseum is still a renowned symbol of Imperial Rome and was listed as one of the New Seven Wonders of the World.
        </div>`,
    3: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Eiffel Tower</strong><br><br>
            The Eiffel Tower is a wrought-iron lattice structure located on the Champ de Mars in Paris, France. It was designed by engineer Gustave Eiffel and constructed between 1887 and 1889 as the entrance arch for the 1889 Exposition Universelle, held to celebrate the centenary of the French Revolution. At the time of completion, it was the tallest man-made structure in the world, standing at 300 meters, later extended to 330 meters with antennas.<br><br>
            Constructed from over 18,000 iron parts and held together by 2.5 million rivets, the tower was initially met with criticism from artists and intellectuals. However, it eventually became one of the most recognizable landmarks in the world. The tower has three public viewing levels, with restaurants on the first and second floors, and an observation deck at the top offering panoramic views of Paris.<br><br>
            The Eiffel Tower weighs approximately 10,100 tons and expands by up to 15 centimeters in the summer due to thermal expansion. It is repainted roughly every seven years to protect the iron from rust and environmental damage. Originally intended to stand for only 20 years, it was preserved due to its usefulness as a radio transmission tower.<br><br>
            Today, the Eiffel Tower remains a functioning broadcast tower and one of the most visited monuments globally. It hosts millions of tourists annually, features cultural exhibitions, light displays, and serves as a national symbol of innovation, French identity, and architectural achievement.
        </div>`,
    4: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Parthenon</strong><br><br>
            The Parthenon is an ancient Greek temple located on the Acropolis of Athens, dedicated to the goddess Athena, the city's patron deity. Constructed between 447 and 432 BCE during the height of the Athenian Empire, it was designed by architects Iktinos and Kallikrates under the supervision of the sculptor Phidias. The structure replaced an earlier temple destroyed during the Persian invasion of 480 BCE.<br><br>
            Built primarily from Pentelic marble, the Parthenon exemplifies the Doric order, though it incorporates Ionic elements. It features eight columns on the façade and seventeen along the sides, with subtle architectural refinements such as a curved base and slightly tilted columns to correct optical illusions. The temple originally housed a massive chryselephantine (gold and ivory) statue of Athena, created by Phidias.<br><br>
            The Parthenon served various roles over the centuries, including a treasury, a Christian church, a mosque, and even an ammunition depot, which led to significant damage during a 17th-century explosion. Despite this, it remains a symbol of ancient Greek civilization and classical ideals of harmony and proportion.<br><br>
            Today, the Parthenon stands as a major archaeological site and cultural monument. It is preserved and studied as part of ongoing restoration efforts by the Greek government and international experts. It continues to represent the legacy of ancient Athens, attracting millions of visitors annually and symbolizing the enduring influence of classical architecture and democracy.
        </div>`,
    5: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The Leaning Tower of Pisa</strong><br><br>
    The Leaning Tower of Pisa is a freestanding bell tower, or campanile, of the cathedral in Pisa, Italy. Construction began in 1173 and continued intermittently over nearly two centuries, finally completing in the 14th century. The tower is famous worldwide for its unintended tilt, caused by unstable foundation soil beneath its base.<br><br>
    Standing about 56 meters tall on the high side, the tower is made of white and grey marble and features eight stories, including the chamber for the seven bells. Its design follows Romanesque architectural style, characterized by rounded arches, columns, and decorative arcading around each level.<br><br>
    The tilt began during construction, when the foundation on one side started to sink into soft ground composed of clay, sand, and shells. Various efforts to correct or stabilize the lean have been made over the centuries, with modern engineering successfully reducing the tilt to about 3.97 degrees, ensuring the tower’s safety while preserving its distinctive angle.<br><br>
    The tower’s lean has made it a symbol of architectural curiosity and resilience, attracting millions of visitors annually. It continues to serve as the bell tower for Pisa’s cathedral and is part of the Piazza dei Miracoli, a UNESCO World Heritage Site, representing medieval Italian art and engineering ingenuity.
        </div>`,          
    6: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The White Tower</strong><br><br>
    The White Tower is a prominent historical monument and museum located on the waterfront of Thessaloniki, Greece. Built in the late 15th century by the Ottomans after their conquest of the city, the tower replaced an older Byzantine fortification and became part of the city’s seafront defensive walls. Standing approximately 34 meters high with a diameter of 22 meters, it was constructed as a cylindrical structure with a flat roof and six interior floors connected by a spiral staircase.<br><br>
    Originally used as a fortress and garrison, the tower also served as a prison and place of execution during the Ottoman period, earning it the nickname "Tower of Blood" or "Red Tower." It was whitewashed and renamed the "White Tower" in the late 19th century, possibly to symbolize a new era and cleanse its dark past.<br><br>
    Architecturally, the White Tower is an example of late medieval military design, combining defensive features with a commanding view of the sea and surrounding city. The outer wall, which once enclosed the tower, was demolished in the early 20th century, leaving the structure as a free-standing monument.<br><br>
    Today, the White Tower functions as a museum managed by the Ephorate of Antiquities. It hosts permanent exhibitions on the history of Thessaloniki from antiquity through the modern era. The top of the tower offers panoramic views of the city and Thermaic Gulf. It stands as a symbol of Thessaloniki’s layered past and its evolving identity through centuries of cultural and political change.
        </div>`,        
    7: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Hagia Sophia</strong><br><br>
    Hagia Sophia is a monumental architectural masterpiece located in Istanbul, Turkey, originally constructed as a cathedral between 532 and 537 CE during the reign of Byzantine Emperor Justinian the First.<br><br>
    Renowned for its massive central dome, it was the largest cathedral in the world for nearly a thousand years and is considered a pinnacle of Byzantine architecture.<br><br>
    The building’s design features a vast nave topped by a 31-meter diameter dome, which appears to float above the space thanks to a ring of windows at its base, creating a sense of divine light. The structure combines a basilica layout with a centralized dome plan, supported by pendentives that transfer the dome’s weight onto four massive piers.<br><br>
    The interior is richly decorated with mosaics depicting religious figures, geometric patterns, and intricate marble work. The use of light and space inside Hagia Sophia creates an awe-inspiring atmosphere, reflecting its original purpose as a place of worship and imperial ceremony.<br><br>
    Its architectural innovations influenced many churches and other buildings for centuries. Today, Hagia Sophia functions as a mosque and remains a UNESCO World Heritage site, admired globally for its historical significance, architectural brilliance, and artistic heritage.
        </div>`,
    8: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">Edinburgh Castle</strong><br><br>
    Edinburgh Castle is a historic fortress located on Castle Rock, a volcanic promontory that dominates the skyline of Scotland’s capital. Archaeological evidence suggests the site has been occupied since at least the Iron Age, but the earliest royal castle on the rock dates back to the 12th century during the reign of King David I.<br><br>
    Over the centuries, the castle has served as a royal residence, military stronghold, and symbol of Scottish power. Its strategic position made it central to many conflicts, including the Wars of Scottish Independence and later struggles between crown and parliament. Despite repeated sieges, it remained a key seat of authority in Scotland.<br><br>
    The castle complex includes a variety of buildings, reflecting different historical periods. Highlights include St. Margaret’s Chapel constructed in the early 12th century, the Great Hall completed in the 16th century, and the Royal Palace, which houses the Honours of Scotland (the Scottish Crown Jewels) and the Stone of Destiny.<br><br>
    Architecturally, the castle showcases medieval and early modern styles, with thick defensive walls, towers, and gates integrated into the rugged landscape. It is both a national monument and a working military site.
</div>`,
    9: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">St. Basil's Cathedral</strong><br><br>
    St. Basil’s Cathedral is an architectural monument located at the southern end of Red Square in Moscow, Russia. It was commissioned by Ivan IV, and constructed between 1555 and 1561 to commemorate the capture of Kazan and Astrakhan.<br><br>
    The cathedral consists of a central church surrounded by eight smaller chapels, each built to honor a specific military victory. These chapels are arranged symmetrically around the central core and are connected by a maze-like system of galleries and passageways. The entire structure rests on a single foundation, unified by a raised platform.<br><br>
    St. Basil’s is most famous for its vibrant, onion-shaped domes, each uniquely decorated with colorful patterns and textures. The design combines traditional Russian architectural elements with influences from Byzantine and Asian styles, creating a highly distinctive silhouette that has become a symbol of Moscow and Russia itself.<br><br>
    Originally painted in more subdued tones, the cathedral received its vivid color scheme in later centuries. Inside, it features narrow corridors, steep stairways, and richly decorated chapels with frescoes, icons, and ornamental details.<br><br>
    Today, St. Basil’s functions as a museum and stands as a UNESCO World Heritage Site. It is widely recognized as a masterpiece of Russian medieval architecture and remains a cultural and national icon.
        </div>`,
            10: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The Atomium</strong><br><br>
    The Atomium is a unique architectural structure and museum located in Brussels, Belgium. It was originally built for Expo 58, the 1958 Brussels World’s Fair, as the centerpiece of the exhibition. Designed by engineer André Waterkeyn and architects André and Jean Polak, the structure represents an iron crystal magnified 165 billion times.<br><br>
    Standing 102 meters tall, the Atomium consists of nine stainless steel-clad spheres, each 18 meters in diameter, connected by tubes housing escalators and stairs. The spheres are arranged to reflect the geometric pattern of a unit cell of iron, symbolizing scientific progress and the optimism of the atomic age. Three of the spheres are not accessible to the public, while the others house exhibitions, event spaces, and a panoramic viewing deck.<br><br>
    Originally intended as a temporary structure, the Atomium was preserved due to its popularity and has since become an enduring landmark of Brussels. It underwent extensive renovation in the early 2000s to modernize its facilities.<br><br>
    Today, the Atomium functions as both a museum and a cultural venue. It hosts permanent and temporary exhibitions focused on science, design, and history, while the top sphere offers a 360-degree view of Brussels and its surroundings. The Atomium remains a powerful symbol of mid-20th century innovation, European unity, and Belgium’s place in the modern scientific world.
        </div>`
};

const descValue = feature.properties.Description;
document.getElementById('tab-desc').innerHTML =
    descriptionMap.hasOwnProperty(descValue)
        ? descriptionMap[descValue]
        : (descValue || "No description available.");

    // --- Image Tab ---
const imageSrc = imageMap[feature.properties.Image];
const imageAttr = imageAttributions[feature.properties.Image] || '';
document.getElementById('tab-img').innerHTML = imageSrc
    ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
            <div style="position:relative;display:inline-block;">
                <img src="${imageSrc}" alt="Monument Image" style="max-width:900px;max-height:640px;border-radius:8px;display:block;">
                ${imageAttr ? `<div class="model-attribution image-attribution">${imageAttr}</div>` : ''}
            </div>
       </div>`
    : 'No image available.';

// --- Audio Tab ---
const audioImg = audioImgMap[feature.properties.Audio];
const audioSrc = audioSrcMap[feature.properties.Audio];
const audioAttr = audioAttributions[feature.properties.Audio] || '';
document.getElementById('tab-audio').innerHTML = (audioImg && audioSrc)
    ? `<div style="position: relative; width: 800px; height: 123px;">
           <img src="${audioImg}" style="width: 100%; height: 100%; border-radius: 7px; border: 2px solid black;">
           <audio controls class="audio" 
                  style="position: absolute; bottom: 30px; left: 335px; transform: translateX(-50%) scale(1.15); transform-origin: center; width: 70%;">
               <source src="${audioSrc}" type="audio/mpeg">
           </audio>
       </div>`
    : 'No audio available.';

// Set the tab-audio container to position relative and add attribution after content is set
document.getElementById('tab-audio').style.position = 'relative';
if (audioAttr) {
    const attrDiv = document.createElement('div');
    attrDiv.className = 'model-attribution';
    attrDiv.style.cssText = 'position: absolute; right: 8px; bottom: 8px; left: auto;';
    attrDiv.textContent = audioAttr;
    document.getElementById('tab-audio').appendChild(attrDiv);
}

// --- Video Tab --- Updated for YouTube embeds with selective controls
const videoSrc = videoMap[feature.properties.Video];
const videoAttr = videoAttributions[feature.properties.Video] || '';
if (videoSrc) {
    // Extract the video ID from the URL
    const match = videoSrc.match(/embed\/([a-zA-Z0-9_-]+)/);
    const videoId = match ? match[1] : '';
    document.getElementById('tab-video').innerHTML = `
        <div style="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
            <iframe src="${videoSrc}?autoplay=1&mute=1&controls=1&modestbranding=1&rel=0&disablekb=1&fs=0&loop=1&playlist=${videoId}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen
                style="width:100%;height:81.8%;border-radius:8px;display:block;">
            </iframe>
            ${videoAttr ? `<div class="model-attribution" style="right:8px;left:auto;bottom:8px;">${videoAttr}</div>` : ''}
        </div>
    `;
} else {
    document.getElementById('tab-video').innerHTML = 'No video available.';
}

// --- 3D Model Tab ---
const modelKey = modelMap[feature.properties['3D Model']];
const glbUrl = glbUrls[modelKey];
const sketchfabUrl = sketchfabUrls[modelKey];
const attribution = modelAttributions[modelKey] || 'Created by Efthimis Se'; // Default fallback

if (glbUrl) {
    document.getElementById('tab-model').innerHTML =
        `<div class="sketchfab-embed-wrapper">
            <model-viewer src="${glbUrl}" alt="3D Model" camera-controls auto-rotate style="width:100%;height:100%;background:#f7f8fa;border-radius:8px;"></model-viewer>
            <div class="model-attribution">${attribution}</div>
        </div>`;
} else if (sketchfabUrl) {
    document.getElementById('tab-model').innerHTML =
        `<div class="sketchfab-embed-wrapper">
            <iframe title="3D Model" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"
                allow="autoplay; fullscreen; xr-spatial-tracking"
                src="${sketchfabUrl}">
            </iframe>
            <div class="model-attribution">${attribution}</div>
        </div>`;
} else {
    document.getElementById('tab-model').innerHTML = 'No 3D model available.';
}

    // --- QR Tab ---
    const qrSrc = qrMap[feature.properties['QR Code']];
    document.getElementById('tab-qr').innerHTML = qrSrc
        ? `<img src="${qrSrc}" height="100%" style="cursor: pointer; border-radius:8px;">`
        : 'No QR code available.';

    // Only for Task 3 and Italian landmarks, trigger completion on QR tab click
if (feature.properties.Country === "Italy" && currentTask === 2) {
    document.getElementById('tab-qr').onclick = function() {
        // Prevent multiple completions
        if (!window._task3Completed) {
            window._task3Completed = true;
            completeCurrentTask();
        }
    };
}

    // Automatically complete Task 3 when QR tab is opened for landmarks in Italy
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            if (tab === 'qr' && feature.properties.Country === "Italy" && currentTask === 2) {
                if (!window._task3Completed) {
                    window._task3Completed = true;
                    completeCurrentTask();
                }
            }
        });
    });


    // Show overlay with animation
    const overlay = document.getElementById('monument-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => overlay.classList.add('open'), 10);

    const blur = document.getElementById('blur-overlay');
    blur.style.display = 'block';
    setTimeout(() => blur.style.opacity = 1, 10);

    // Default to Info tab
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
    document.querySelector('.tab-btn[data-tab="info"]').classList.add('active');
    document.getElementById('tab-info').style.display = 'flex';
}

function closeMonumentOverlay() {
    // Stop all audio in the overlay
    document.querySelectorAll('#monument-overlay audio').forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
    });

    // 🟢 Finalize time spent in the current tab before closing
    const now = Date.now();
    if (currentTab && tabLastEnterTime[currentTab] !== null) {
        tabTotalTimes[currentTab] += (now - tabLastEnterTime[currentTab]) / 1000;
        tabLastEnterTime[currentTab] = null;
    }
    currentTab = null;

    const overlay = document.getElementById('monument-overlay');
    const blur = document.getElementById('blur-overlay');
    overlay.classList.remove('open');
    blur.style.opacity = 0;
    setTimeout(() => {
        overlay.style.display = 'none';
        blur.style.display = 'none';
    }, 500);
}

// Carousel slides content (replace with your actual instructions later)

const carouselSlides = [
    `<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;width:100%;box-sizing:border-box;">
        <div style="flex:1 1 auto;width:100%;overflow-y:auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:15px;box-sizing:border-box;">
            <div style="text-align:center;margin-bottom:20px;flex-shrink:0;">
                <h2 style="font-size:2.8em;color:#2563eb;margin-bottom:10px;font-family:Arial;">Instructions</h2>
            </div>
            
            <div style="max-width:800px;text-align:justify;margin-bottom:25px;flex-shrink:0;">
                <ul style="font-size:1.2em;line-height:1.4;color:#333;font-family:Arial;padding-left:20px;margin:0;">
                    <li style="margin-bottom:12px;">In this application, you will explore both historic and modern famous monuments and landmarks using an interactive map.</li>
                    <li style="margin-bottom:12px;">You will be guided through a series of short tasks that you will have to complete using information provided by the app in various multimedia types.</li>
                    <li style="margin-bottom:12px;">Some tasks may involve viewing images, listening to audio clips, or interacting with 3D models, others may require you to combine information from multiple sources.</li>
                    <li style="margin-bottom:0;">There is no time limit on the tasks.</li>
                </ul>
            </div>
            <div style="font-weight:bold; font-family:Arial; margin-top:5px; margin-bottom:8px; font-size:1.1em; text-align:center;flex-shrink:0;">
                Please enter a 6-digit code of your choice below.
            </div>
            <div style="color:#c0392b; background:#fffbe6; border:1px solid #ffe58f; border-radius:6px; padding:16px 24px; margin-bottom:8px; font-size:1.08em; max-width:600px; text-align:center; font-family:Arial;flex-shrink:0;">
                <b>Hint!</b> You will need this code to proceed to Questionnaire part of the research, so please select a 6-digit code you can easily remember.
            </div>
            <div style="flex-shrink:0;">
                <input id="user-code-input" type="text" maxlength="6" pattern="\\d{6}" 
                    style="font-size:1.3em;padding:8px 16px;width:180px;text-align:center;border-radius:6px;border:1px solid #bbb;letter-spacing:0.3em;margin-top:10px;display:block;font-family:Arial;" autocomplete="off" />
                <div id="code-error-msg" style="color:#c0392b;font-size:1em;margin-top:8px;height:22px;visibility:hidden;text-align:center;font-family:Arial;">
                    The code must be 6 digits.
                </div>
            </div>
        </div>
    </div>`,
// Modified second slide with proper horizontal alignment
`<div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;width:100%;box-sizing:border-box;">
    <div style="flex:1 1 auto;width:100%;overflow-y:auto;display:flex;flex-direction:row;align-items:flex-start;justify-content:center;padding:15px;box-sizing:border-box;gap:30px;">
<!-- Left Half -->
<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;max-width:50%;height:100%;">
    <!-- Header section with fixed height -->
    <div style="height:60px;display:flex;align-items:center;justify-content:center;margin-bottom:20px;">
        <h2 style="text-align:center;font-size:1.6em;color:#2563eb;margin:0;font-family:Arial;">How Tasks Work</h2>
    </div>
    
    <!-- Content section with natural height -->
    <div style="width:100%;display:flex;flex-direction:column;justify-content:center;margin-bottom:0;margin-top:0;">
        <ul style="font-size:1em;line-height:1.4;color:#333;font-family:Arial;padding-left:20px;margin:0;text-align:left;">
            <li style="margin-bottom:10px;margin-top:10px;">Tasks will appear at the bottom of the screen as you use the application.</li>
            <li style="margin-bottom:10px;">When you complete a task, you must press "Continue" to submit your answer.</li>
            <li style="margin-bottom:10px;">The task box will turn green, to confirm your answers have been successfully submitted.</li>
            <li style="margin-bottom:10px;">The next task will appear automatically, after answer submission.</li>
            <li style="margin-bottom:10px;">There are a total of 10 tasks to complete.</li>
            <li style="margin-bottom:0;"><b>Please note: You cannot go back to a previous task once it is submitted.</b></li>
        </ul>
    </div>
    
    <!-- Image section with margin-top for spacing -->
    <div style="width:90%;display:flex;align-items:center;justify-content:center;margin-top:10px;">
        <img src="images/Tasks.png" alt="Task Example" style="width:100%;max-height:100%;object-fit:contain;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,0.12);">
    </div>
</div>
        <!-- Right Half -->
        <div style="fixed:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;max-width:50%;height:100%;">
            <!-- Header section with fixed height -->
            <div style="height:60px;display:flex;align-items:center;justify-content:center;margin-bottom:5px;">
                <h2 style="text-align:center;font-size:1.6em;color:#2563eb;margin:0;font-family:Arial;">Navigation Tips</h2>
            </div>
            
            <!-- Image section with fixed height -->
            <div style="height:230px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;margin-bottom:30px;">
                <img src="images/Navigation.png" alt="Navigation Example" style="width:100%;height:100%;object-fit:contain;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,0.12);">
            </div>
            
            <!-- Content section with fixed height (moved below image) -->
            <div style="height:200px;display:fixed;flex-direction:column;justify-content:center;">
                <ul style="font-size:1em;line-height:1.4;color:#333;font-family:Arial;padding-left:20px;margin:0;text-align:left;">
                    <li style="margin-bottom:10px;">Click on monument markers to open detailed information panels.</li>
                    <li style="margin-bottom:10px;">Use the tabs to explore different content types.</li>
                    <li style="margin-bottom:10px;">Use mouse controls to zoom and navigate around the world.</li>
                    <li style="margin-bottom:10px;"><b>All information required to complete the tasks is provided within the application or through external websites accessed via QR codes generated by the application. No prior knowledge is necessary and external search (e.g. independent Google Search) should not be used.</b></li>
                    <li style="margin-bottom:0;">Pay close attention to task instructions at the bottom of the screen.</li>
                </ul>
            </div>
        </div>
    </div>
</div>`,

    `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;margin-bottom:10px;">
        <h2 style="text-align:center;width:100%;">Finishing Tasks</h2><br><br>
        <p style="text-align:center;width:100%; font-family: Arial;">
            <b>Upon completion, click the "Proceed to Questionnaire" button</b> to continue to second part of the research.<br><br>
            You can then explore the application without any limitations.<br><br>
            Please make sure you submit both parts of the research.<br><br><br><br>
            <b>Thank you for your participation!</b><br><br>
        </p>
    </div>`
];

let userSixDigitCode = ""; // Store the code in JS

// --- Update renderCarouselSlides to gray out and disable "Previous" on slide 2 ---
function renderCarouselSlides(newIdx, direction = 0) {
    const slidesDiv = document.getElementById('carousel-slides');
    while (slidesDiv.firstChild) slidesDiv.removeChild(slidesDiv.firstChild);

    const prevSlideEl = document.createElement('div');
    prevSlideEl.className = 'carousel-slide active';
    prevSlideEl.innerHTML = carouselSlides[lastSlide];

    const newSlideEl = document.createElement('div');
    newSlideEl.className = 'carousel-slide';
    newSlideEl.innerHTML = carouselSlides[newIdx];

    if (direction === 0) {
        newSlideEl.classList.add('active');
        slidesDiv.appendChild(newSlideEl);
    } else {
        slidesDiv.appendChild(prevSlideEl);
        slidesDiv.appendChild(newSlideEl);
        void prevSlideEl.offsetWidth;
        prevSlideEl.classList.remove('active');
        prevSlideEl.classList.add(direction > 0 ? 'slide-out-left' : 'slide-out-right');
        newSlideEl.classList.add(direction > 0 ? 'slide-in-right' : 'slide-in-left');
        setTimeout(() => {
            slidesDiv.innerHTML = '';
            newSlideEl.className = 'carousel-slide active';
            slidesDiv.appendChild(newSlideEl);
        }, 450);
    }

    // Dots
    const dotsDiv = document.getElementById('carousel-dots');
    dotsDiv.innerHTML = '';
for (let i = 0; i < carouselSlides.length; i++) {
    const dot = document.createElement('span');
    dot.style.width = '13px';
    dot.style.height = '13px';
    dot.style.borderRadius = '50%';
    dot.style.display = 'inline-block';
    dot.style.background = i === newIdx ? '#2563eb' : '#bbb';
    dot.style.cursor = 'pointer';

    // Prevent moving to slides > 0 if code not submitted
    if ((i > 0 && !userSixDigitCode) || (i === 0 && currentSlide > 0)) {
        // Do not assign onclick, so it's not clickable
    } else {
        dot.onclick = () => {
            if (i !== currentSlide) {
                lastSlide = currentSlide;
                currentSlide = i;
                renderCarouselSlides(currentSlide, i > lastSlide ? 1 : -1);
            }
        };
    }
    dotsDiv.appendChild(dot);
}

// Prevent moving forward if code not submitted
if (!userSixDigitCode && newIdx > 0) {
    // If trying to render slide 2 or 3 without code, force back to slide 0
    setTimeout(() => {
        lastSlide = newIdx;
        currentSlide = 0;
        renderCarouselSlides(0, -1);
    }, 0);
    return;
}

    // Checkbox logic
    const checkboxRow = document.getElementById('carousel-checkbox-row');
    const agreeCheckbox = document.getElementById('carousel-agree-checkbox');
    const nextBtn = document.getElementById('carousel-next');
    const prevBtn = document.getElementById('carousel-prev');
    if (newIdx === carouselSlides.length - 1) {
        checkboxRow.style.display = 'flex';
        nextBtn.textContent = 'Start';
        nextBtn.disabled = !agreeCheckbox.checked;
    } else {
        checkboxRow.style.display = 'none';
        nextBtn.textContent = 'Next';
        nextBtn.disabled = false;
        if (agreeCheckbox) agreeCheckbox.checked = false;
    }

// --- Disable and gray out "Previous" on slide 2 ---
if (newIdx === 1) {
    prevBtn.disabled = true;
    prevBtn.style.opacity = "0.5";
    prevBtn.style.pointerEvents = "none";
    prevBtn.style.background = "#e0e0e0";
    prevBtn.style.color = "#888";
    prevBtn.style.border = "none";
} else {
    prevBtn.disabled = false;
    prevBtn.style.opacity = "";
    prevBtn.style.pointerEvents = "";
    prevBtn.style.background = "";
    prevBtn.style.color = "";
    prevBtn.style.border = "";
}
prevBtn.style.visibility = newIdx === 0 ? 'hidden' : 'visible';

// --- 6-digit code validation logic for first slide ---
if (newIdx === 0) {
    const forbiddenCodes = [
        "000000", "111111", "222222", "333333", "444444", "555555", "666666", "777777", "888888", "999999",
        "123456", "654321", "112233", "121212", "101010", "222333", "333444", "444555", "555666", "666777", "777888", "888999", "012345", "543210","010101", "020202", "030303", "040404", "050505", "060606", "070707", "080808", "090909",
        "123123", "321321", "456456", "654654", "789789", "000011", "000022", "000033", "000044", "000055", "000066", "000077", "000088", "000099", "100000", "200000", "300000", "400000", "500000", "600000", "700000", "800000", "900000", "987654"
    ];
    const codeInput = document.getElementById('user-code-input');
    const codeError = document.getElementById('code-error-msg');
    nextBtn.disabled = true;
    codeInput.addEventListener('input', function () {
        // Only allow digits
        this.value = this.value.replace(/\D/g, '').slice(0, 6);
        if (this.value.length === 6) {
            if (forbiddenCodes.includes(this.value)) {
                codeError.textContent = "Please choose a different code.";
                codeError.style.visibility = 'visible';
                nextBtn.disabled = true;
            } else {
                codeError.textContent = "The code must be 6 digits.";
                codeError.style.visibility = 'hidden';
                nextBtn.disabled = false;
            }
        } else {
            codeError.textContent = "The code must be 6 digits.";
            codeError.style.visibility = this.value.length > 0 ? 'visible' : 'hidden';
            nextBtn.disabled = true;
        }
    });
    nextBtn.onclick = function () {
        if (codeInput.value.length === 6 && !forbiddenCodes.includes(codeInput.value)) {
            userSixDigitCode = codeInput.value;
            lastSlide = currentSlide;
            currentSlide++;
            renderCarouselSlides(currentSlide, 1);
        } else {
            codeError.textContent = forbiddenCodes.includes(codeInput.value)
                ? "Please choose a different code."
                : "The code must be 6 digits.";
            codeError.style.visibility = 'visible';
        }
    };
} else {
    // Restore default next button behavior for other slides
    nextBtn.onclick = function () {
        // Prevent moving forward if code not submitted
        if (!userSixDigitCode) return;
        if (currentSlide < carouselSlides.length - 1) {
            lastSlide = currentSlide;
            currentSlide++;
            renderCarouselSlides(currentSlide, 1);
        } else if (!this.disabled) {
            // Hide carousel overlay smoothly
            const overlay = document.getElementById('carousel-overlay');
            overlay.classList.remove('open');
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.opacity = 0;
                showTaskCounter();
            }, 500);
        }
    };
}}

// Checkbox event: enable/disable the "Έναρξη" button
document.getElementById('carousel-agree-checkbox').addEventListener('change', function() {
    const nextBtn = document.getElementById('carousel-next');
    nextBtn.disabled = !this.checked;
});

// Navigation buttons
document.getElementById('carousel-prev').onclick = function() {
    if (currentSlide > 0) {
        lastSlide = currentSlide;
        currentSlide--;
        renderCarouselSlides(currentSlide, -1);
    }
};
document.getElementById('carousel-next').onclick = function() {
    if (currentSlide < carouselSlides.length - 1) {
        lastSlide = currentSlide;
        currentSlide++;
        renderCarouselSlides(currentSlide, 1);
    } else if (!this.disabled) {
        // Hide carousel overlay smoothly
        const overlay = document.getElementById('carousel-overlay');
        overlay.classList.remove('open');
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.opacity = 0;
        }, 500);
    }
};

// Show carousel after welcome screen
document.getElementById('welcome-button').addEventListener('click', function () {
    setTimeout(() => {
        const overlay = document.getElementById('carousel-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('open'), 10);
        currentSlide = 0;
        lastSlide = 0;
        renderCarouselSlides(0, 0);
    }, 550); // after welcome screen fades out
});

// Prevent closing with Escape or clicking outside
document.getElementById('carousel-overlay').addEventListener('click', function(e) {
    if (e.target === this) {
        e.stopPropagation();
    }
});
document.addEventListener('keydown', function (event) {
    if (document.getElementById('carousel-overlay').classList.contains('open') && event.key === 'Escape') {
        event.preventDefault();
    }
});

// --- TASK SYSTEM ---
const tasks = [
    { text: "Task 1/10: Navigate to The Atomium, Belgium and count the total number of spheres that make up the structure." },
    { text: "Task 2/10: Navigate to The Leaning Tower of Pisa, Italy and enter the angle at which it is tilted. Round your answer to the nearest whole number." },
    { text: "Task 3/10: Examine the Parthenon, Greece and count the number of broken outer columns." },
    { text: "Task 4/10: Using the 3D model of the Big Ben, England, determine how many hours it would take for the clock to match the time shown in the Big Ben image. Round your answer to the nearest whole hour." },
    { text: "Task 5/10: Select 4 monuments that, based on images or videos provided, appear to be located near the sea or a river." },
    { text: "Task 6/10: Count the 3D models missing a flag that is present in both the photo and video versions of the same landmark." },
    { text: "Task 7/10: Determine whether it is possible to visit the Hagia Sophia Mosque, Turkey on December 1st at 08:30 in the morning." },
    { text: "Task 8/10: Identify the average audience capacity of the Colosseum, Italy." },
    { text: "Task 9/10: Find out how many Rubles does an adult entrance ticket cost to St. Basil's Cathedral, Russia." },
    { text: "Task 10/10: If you wish, feel free to explore the application. When you are ready, type 'OK' to proceed to the questionnaire." },
    { text: "Congratulations! You can now freely explore the application. Thank you for your participation!" }
];

let currentTask = 0;
// Keep answers array for tasks 1..10 (indices 0..9)
let taskAnswers = ["", "", "", "", "", "", "", "", "", ""]; 
let finalTaskUnlocked = false;

// Track task timing
let taskStartTimes = [];
let taskEndTimes = [];
let taskDurations = [];

// Track total time spent in each tab
const tabNames = ['info', 'desc', 'img', 'audio', 'video', 'model', 'qr'];
let tabTotalTimes = {};
let tabLastEnterTime = {};
let currentTab = null;

function resetTabTimers() {
    tabNames.forEach(tab => {
        tabTotalTimes[tab] = 0;
        tabLastEnterTime[tab] = null;
    });
    currentTab = null;
}
resetTabTimers();

// Track number of clicks per tab
let tabClickCounts = {};
tabNames.forEach(tab => tabClickCounts[tab] = 0);

function resetTabClickCounts() {
    tabNames.forEach(tab => tabClickCounts[tab] = 0);
}

// Helper to safely replace continue button (remove listeners)
function freshContinueButton() {
    const old = document.getElementById('task-continue-btn');
    const clone = old.cloneNode(true);
    old.parentNode.replaceChild(clone, old);
    return clone;
}

// Show the current task and continue button
function showTaskCounter() {
    const el = document.getElementById('task-counter');
    const textEl = document.getElementById('task-counter-text');
    el.style.display = 'block';

    // Always set the start time for the current task if not already set
    if (!taskStartTimes[currentTask]) {
        taskStartTimes[currentTask] = Date.now();
    }

// Tasks 1-4: text input (Tasks 1, 2, 3, 4 are numeric only)
if (currentTask < 4) {
    const isNumericTask = true; // All tasks 1-4 are now numeric
    const isWholeNumberOnly = currentTask === 1 || currentTask === 3; // Task 2 (index 1) and Task 4 (index 3) - no decimals
    
    textEl.innerHTML = `
        ${tasks[currentTask].text}
        <br>
        <input type="text" id="task-input-${currentTask}" style="margin-top:10px;padding:8px 14px;font-size:1em;border-radius:6px;border:1px solid #bbb;width:260px;" autocomplete="off" inputmode="numeric" />
    `;
    el.style.color = '#c0392b';
    el.style.borderColor = '#c0392b';
    el.style.background = '#fff';

    const freshBtn = freshContinueButton();
    freshBtn.style.display = 'inline-block';
    freshBtn.disabled = true;
    freshBtn.textContent = 'Continue';

    const input = document.getElementById(`task-input-${currentTask}`);
    
    if (isWholeNumberOnly) {
        // For Tasks 2 and 4: only allow whole numbers (no decimal points)
        input.addEventListener('input', function() {
            // Remove any non-numeric characters (including decimal points)
            this.value = this.value.replace(/[^0-9]/g, '');
            freshBtn.disabled = this.value.trim() === '';
        });
    } else {
        // For Tasks 1, 3: allow numbers and decimal points
        input.addEventListener('input', function() {
            // Remove any non-numeric characters except decimal point
            this.value = this.value.replace(/[^0-9.]/g, '');
            // Ensure only one decimal point
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts.slice(1).join('');
            }
            freshBtn.disabled = this.value.trim() === '';
        });
    }

    let animating = false;
    function handler() {
        if (animating || freshBtn.disabled) return;
        animating = true;
        freshBtn.disabled = true;
        input.disabled = true;
        new Audio('sounds/TaskComplete.mp3').play();
        taskAnswers[currentTask] = input.value.trim();
        closeMonumentOverlay();
        taskEndTimes[currentTask] = Date.now();
        taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000;
        el.style.background = '#eafaf1';
        el.style.color = '#27ae60';
        el.style.borderColor = '#27ae60';
        setTimeout(() => {
            animating = false;
            currentTask++;
            if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
            showTaskCounter();
        }, 1000);
        freshBtn.removeEventListener('click', handler);
    }
    freshBtn.addEventListener('click', handler);
}
    // Task 5: choose exactly 4 monuments (checkboxes)
    else if (currentTask === 4) {
        const monumentList = [
            "Big Ben",
            "Brandenburg Gate",
            "Colosseum",
            "Eiffel Tower",
            "The Parthenon",
            "Leaning Tower of Pisa",
            "White Tower of Thessaloniki",
            "Hagia Sophia",
            "Edinburgh Castle",
            "St. Basil's Cathedral",
            "The Atomium"
        ];
        textEl.innerHTML = `
            ${tasks[currentTask].text}
            <br>
            <div id="monument-checkbox-list" style="margin-top:18px;display:flex;flex-wrap:wrap;gap:18px;justify-content:center;scale(1.1)">
                ${monumentList.map(name => `
                    <label style="display:flex;align-items:center;gap:7px;">
                        <input type="checkbox" value="${name}" class="monument-checkbox" style="margin-right:2px;">
                        <span style="color:#222;font-weight:500;font-size:1em;">${name}</span>
                    </label>
                `).join('')}
            </div>
        `;
        el.style.color = '#c0392b';
        el.style.borderColor = '#c0392b';
        el.style.background = '#fff';

        const freshBtn = freshContinueButton();
        freshBtn.style.display = 'inline-block';
        freshBtn.disabled = true;
        freshBtn.textContent = 'Continue';

        const checkboxes = document.querySelectorAll('.monument-checkbox');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const checked = Array.from(checkboxes).filter(box => box.checked);
                if (checked.length > 4) this.checked = false;
                const checkedNow = Array.from(checkboxes).filter(box => box.checked);
                freshBtn.disabled = checkedNow.length !== 4;
            });
        });

        let animating = false;
        function handler() {
            if (animating || freshBtn.disabled) return;
            animating = true;
            freshBtn.disabled = true;
            checkboxes.forEach(cb => cb.disabled = true);
            new Audio('sounds/TaskComplete.mp3').play();
            const checked = Array.from(checkboxes).filter(box => box.checked).map(cb => cb.value);
            taskAnswers[4] = checked.join(", ");
            closeMonumentOverlay();
            taskEndTimes[currentTask] = Date.now();
            taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000;
            el.style.background = '#eafaf1';
            el.style.color = '#27ae60';
            el.style.borderColor = '#27ae60';
            setTimeout(() => {
                animating = false;
                currentTask++;
                if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
                showTaskCounter();
            }, 1000);
            freshBtn.removeEventListener('click', handler);
        }
        freshBtn.addEventListener('click', handler);
    }
    // Task 6: numeric/text input for missing flags (MAKE NUMERIC ONLY)
    else if (currentTask === 5) {
        textEl.innerHTML = `
            ${tasks[currentTask].text}
            <br>
            <input type="text" id="task-input-5" style="margin-top:10px;padding:8px 14px;font-size:1em;border-radius:6px;border:1px solid #bbb;width:260px;" autocomplete="off" inputmode="numeric" />
        `;
        el.style.color = '#c0392b';
        el.style.borderColor = '#c0392b';
        el.style.background = '#fff';

        const freshBtn = freshContinueButton();
        freshBtn.style.display = 'inline-block';
        freshBtn.disabled = true;
        freshBtn.textContent = 'Continue';

        const input = document.getElementById('task-input-5');
        input.addEventListener('input', function() {
            // Remove any non-numeric characters except decimal point
            this.value = this.value.replace(/[^0-9.]/g, '');
            // Ensure only one decimal point
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts.slice(1).join('');
            }
            freshBtn.disabled = this.value.trim() === '';
        });

        let animating = false;
        function handler() {
            if (animating || freshBtn.disabled) return;
            animating = true;
            freshBtn.disabled = true;
            input.disabled = true;
            new Audio('sounds/TaskComplete.mp3').play();
            taskAnswers[5] = input.value.trim();
            closeMonumentOverlay();
            taskEndTimes[currentTask] = Date.now();
            taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000;
            el.style.background = '#eafaf1';
            el.style.color = '#27ae60';
            el.style.borderColor = '#27ae60';
            setTimeout(() => {
                animating = false;
                currentTask++;
                if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
                showTaskCounter();
            }, 1000);
            freshBtn.removeEventListener('click', handler);
        }
        freshBtn.addEventListener('click', handler);
    }
    // Task 7: Yes / No selection rendered as boxed options (like task 5 style)
    else if (currentTask === 6) {
        textEl.innerHTML = `
            ${tasks[currentTask].text}
            <br>
            <div id="task7-yn-row" style="margin-top:18px;display:flex;gap:24px;justify-content:center;flex-wrap:wrap;">
                <label style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px 18px;border-radius:8px;border:1px solid #ddd;cursor:pointer;min-width:120px;">
                    <input type="checkbox" value="Yes" class="task7-yn-checkbox" style="transform:scale(1.2);margin-bottom:6px;">
                    <span style="color:#222;font-weight:600;font-size:1.05em;">Yes</span>
                </label>
                <label style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px 18px;border-radius:8px;border:1px solid #ddd;cursor:pointer;min-width:120px;">
                    <input type="checkbox" value="No" class="task7-yn-checkbox" style="transform:scale(1.2);margin-bottom:6px;">
                    <span style="color:#222;font-weight:600;font-size:1.05em;">No</span>
                </label>
            </div>
        `;
        el.style.color = '#c0392b';
        el.style.borderColor = '#c0392b';
        el.style.background = '#fff';

        const freshBtn = freshContinueButton();
        freshBtn.style.display = 'inline-block';
        freshBtn.disabled = true;
        freshBtn.textContent = 'Continue';

        const checkboxes = document.querySelectorAll('.task7-yn-checkbox');
        // allow only one checked, toggle behaviour
        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    checkboxes.forEach(other => { if (other !== this) other.checked = false; });
                    freshBtn.disabled = false;
                } else {
                    // if none checked, disable continue
                    const any = Array.from(checkboxes).some(x => x.checked);
                    freshBtn.disabled = !any;
                }
            });
        });

        let animating = false;
        function handler() {
            if (animating || freshBtn.disabled) return;
            animating = true;
            freshBtn.disabled = true;
            checkboxes.forEach(cb => cb.disabled = true);
            new Audio('sounds/TaskComplete.mp3').play();
            const checked = Array.from(checkboxes).find(cb => cb.checked);
            taskAnswers[6] = checked ? checked.value : "";
            closeMonumentOverlay();
            taskEndTimes[currentTask] = Date.now();
            taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000;
            el.style.background = '#eafaf1';
            el.style.color = '#27ae60';
            el.style.borderColor = '#27ae60';
            setTimeout(() => {
                animating = false;
                currentTask++;
                if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
                showTaskCounter();
            }, 1000);
            freshBtn.removeEventListener('click', handler);
        }
        freshBtn.addEventListener('click', handler);
    }
    // Tasks 8-10: text input (Tasks 8, 9 are numeric whole numbers only, Task 10 accepts only "OK")
    else if (currentTask >= 7 && currentTask <= 9) {
        const isTaskEightOrNine = currentTask === 7 || currentTask === 8; // Tasks 8, 9 (indices 7, 8)
        const isTaskTen = currentTask === 9; // Task 10 (index 9)
        
        textEl.innerHTML = `
            ${tasks[currentTask].text}
            <br>
            <input type="text" id="task-input-${currentTask}" style="margin-top:10px;padding:8px 14px;font-size:1em;border-radius:6px;border:1px solid #bbb;width:260px;" autocomplete="off" ${isTaskEightOrNine ? 'inputmode="numeric"' : ''} />
        `;
        el.style.color = '#c0392b';
        el.style.borderColor = '#c0392b';
        el.style.background = '#fff';

        const freshBtn = freshContinueButton();
        freshBtn.style.display = 'inline-block';
        freshBtn.disabled = true;
        freshBtn.textContent = 'Continue';

        const input = document.getElementById(`task-input-${currentTask}`);
        
        if (isTaskEightOrNine) {
            // For Tasks 8, 9: only allow whole numbers (no decimal points)
            input.addEventListener('input', function() {
                // Remove any non-numeric characters (including decimal points)
                this.value = this.value.replace(/[^0-9]/g, '');
                freshBtn.disabled = this.value.trim() === '';
            });
        } else if (isTaskTen) {
            // For Task 10: only accept "OK" (case insensitive)
            input.addEventListener('input', function() {
                // Convert to uppercase and limit to 2 characters
                this.value = this.value.toUpperCase().slice(0, 2);
                freshBtn.disabled = this.value !== 'OK';
            });
        }

        let animating = false;
        function handler() {
            if (animating || freshBtn.disabled) return;
            animating = true;
            freshBtn.disabled = true;
            input.disabled = true;
            new Audio('sounds/TaskComplete.mp3').play();
            taskAnswers[currentTask] = input.value.trim();
            closeMonumentOverlay();
            taskEndTimes[currentTask] = Date.now();
            taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000;
            el.style.background = '#eafaf1';
            el.style.color = '#27ae60';
            el.style.borderColor = '#27ae60';
            setTimeout(() => {
                animating = false;
                currentTask++;
                if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
                
                // Show questionnaire overlay after Task 10 completion
                if (currentTask === 10) {
                    showQuestionnaireOverlay();
                } else {
                    showTaskCounter();
                }
            }, 1000);
            freshBtn.removeEventListener('click', handler);
        }
        freshBtn.addEventListener('click', handler);
    }
    // If tasks beyond 10 are locked until reporting completes
    else if (currentTask >= 10 && !finalTaskUnlocked) {
        el.style.display = 'none';
        document.getElementById('task-continue-btn').style.display = 'none';
    }
    else if (finalTaskUnlocked) {
        textEl.textContent = tasks[10].text;
        el.style.color = '#2563eb';
        el.style.borderColor = '#2563eb';
        el.style.background = '#f0f6ff';
        document.getElementById('task-continue-btn').style.display = 'none';
        el.style.display = 'block';
    }
}

// Tab button logic: track time and clicks
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.getAttribute('data-tab');
        const now = Date.now();
        if (currentTab && tabLastEnterTime[currentTab] !== null) {
            tabTotalTimes[currentTab] += (now - tabLastEnterTime[currentTab]) / 1000; // seconds
        }
        tabLastEnterTime[tab] = now;
        currentTab = tab;
        tabClickCounts[tab] = (tabClickCounts[tab] || 0) + 1;
    });
});

// Continue button fallback (kept minimal) — per-case handlers use freshContinueButton, so this is a safe fallback
document.getElementById('task-continue-btn').addEventListener('click', function() {
    // Record end time and duration for the current task if not already recorded by per-case handler
    if (!taskEndTimes[currentTask]) {
        taskEndTimes[currentTask] = Date.now();
        taskDurations[currentTask] = (taskEndTimes[currentTask] - (taskStartTimes[currentTask] || Date.now())) / 1000;
    }
    // Advance to next task (fallback)
    currentTask++;
    if (currentTask < tasks.length && !taskStartTimes[currentTask]) taskStartTimes[currentTask] = Date.now();
    showTaskCounter();
});

// --- EMAILJS REPORTING ---
function showQuestionnaireOverlay() {
    const overlay = document.getElementById('form-redirect-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => overlay.classList.add('open'), 10);

    // Disable the button until email is sent
    const btn = document.getElementById('open-form-btn');
    btn.disabled = true;
    btn.textContent = "Please Wait...";

    // Send the email
    sendResultsByEmailJS(taskDurations, function(success) {
        if (success) {
            btn.disabled = false;
            btn.textContent = "Proceed to Questionnaire";
            btn.onclick = function() {
                overlay.classList.remove('open');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    // Now show the final task
                    finalTaskUnlocked = true;
                    showTaskCounter();
                }, 500);

                // Open the questionnaire in a new tab, prefilled with user code if available
                const entryId = "entry.1012657552"; // <-- Replace with your field's entry ID
                const formBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSeyK30cKMTxVxK4pa1yqFX0O-pN3tEJ_V8ik1CXQeRIYyA3yg/viewform";
                const prefillUrl = `${formBaseUrl}?${entryId}=${encodeURIComponent(userSixDigitCode || '')}`;
                window.open(prefillUrl, "_blank");
            };
        } else {
            btn.disabled = false;
            btn.textContent = "Please Try Again";
            btn.onclick = function() {
                showQuestionnaireOverlay(); // Retry
            };
        }
    });
}

const EMAILJS_KEY_1 = "m-3bZ_uYvA5aIAGtc"; // First account public key
const EMAILJS_KEY_2 = "XNumQOTyR4JIaDFa7"; // Second account public key

function sendResultsByEmailJS(taskDurations, callback) {
    // Prepare CSV content with all 10 tasks included
    const csvRows = [
        [
            "ID",
            "TASK 1 TIME",
            "TASK 2 TIME",
            "TASK 3 TIME",
            "TASK 4 TIME",
            "TASK 5 TIME",
            "TASK 6 TIME",
            "TASK 7 TIME",
            "TASK 8 TIME",
            "TASK 9 TIME",
            "TASK 10 TIME",
            "TOTAL TAB DESC TIME",
            "TOTAL TAB AUDIO TIME",
            "TOTAL TAB IMAGE TIME",
            "TOTAL TAB VIDEO TIME",
            "TOTAL TAB 3D MODEL TIME",
            "TOTAL TAB QR CODE TIME",
            "NO. OF CLICKS DESC",
            "NO. OF CLICKS AUDIO",
            "NO. OF CLICKS IMAGE",
            "NO. OF CLICKS VIDEO",
            "NO. OF CLICKS 3D MODEL",
            "NO. OF CLICKS QR",
            "TASK 1 ANSWER",
            "TASK 2 ANSWER",
            "TASK 3 ANSWER",
            "TASK 4 ANSWER",
            "TASK 5 ANSWERS",
            "TASK 6 ANSWER",
            "TASK 7 ANSWER",
            "TASK 8 ANSWER",
            "TASK 9 ANSWER",
            "TASK 10 ANSWER"
        ],
        [
            userSixDigitCode || "",
            (taskDurations[0] !== undefined ? taskDurations[0].toFixed(2) : ""),
            (taskDurations[1] !== undefined ? taskDurations[1].toFixed(2) : ""),
            (taskDurations[2] !== undefined ? taskDurations[2].toFixed(2) : ""),
            (taskDurations[3] !== undefined ? taskDurations[3].toFixed(2) : ""),
            (taskDurations[4] !== undefined ? taskDurations[4].toFixed(2) : ""),
            (taskDurations[5] !== undefined ? taskDurations[5].toFixed(2) : ""),
            (taskDurations[6] !== undefined ? taskDurations[6].toFixed(2) : ""),
            (taskDurations[7] !== undefined ? taskDurations[7].toFixed(2) : ""),
            (taskDurations[8] !== undefined ? taskDurations[8].toFixed(2) : ""),
            (taskDurations[9] !== undefined ? taskDurations[9].toFixed(2) : ""),
            (tabTotalTimes['desc'] !== undefined ? tabTotalTimes['desc'].toFixed(2) : "0"),
            (tabTotalTimes['audio'] !== undefined ? tabTotalTimes['audio'].toFixed(2) : "0"),
            (tabTotalTimes['img'] !== undefined ? tabTotalTimes['img'].toFixed(2) : "0"),
            (tabTotalTimes['video'] !== undefined ? tabTotalTimes['video'].toFixed(2) : "0"),
            (tabTotalTimes['model'] !== undefined ? tabTotalTimes['model'].toFixed(2) : "0"),
            (tabTotalTimes['qr'] !== undefined ? tabTotalTimes['qr'].toFixed(2) : "0"),
            tabClickCounts['desc'] || "0",
            tabClickCounts['audio'] || "0",
            tabClickCounts['img'] || "0",
            tabClickCounts['video'] || "0",
            tabClickCounts['model'] || "0",
            tabClickCounts['qr'] || "0",
            taskAnswers[0] || "",
            taskAnswers[1] || "",
            taskAnswers[2] || "",
            taskAnswers[3] || "",
            taskAnswers[4] || "",
            taskAnswers[5] || "",
            taskAnswers[6] || "",
            taskAnswers[7] || "",
            taskAnswers[8] || "",
            taskAnswers[9] || ""
        ]
    ];
    const csvContent = csvRows.map(row => row.map(cell => {
        // Escape quotes and wrap fields containing commas or newlines
        const s = String(cell).replace(/"/g, '""');
        return (/,|\n/.test(s)) ? `"${s}"` : s;
    }).join(",")).join("\r\n");

    // Prepare EmailJS params
    const params = {
        subject: "User Task Times CSV",
        message: "See attached CSV for user task times.",
        csv_attachment: csvContent
    };

    // Decide which EmailJS service/template to use based on last digit of code
    const lastDigit = (userSixDigitCode || "").slice(-1);
    let serviceId, templateId, publicKey;
    if (["0", "2", "4", "6", "8"].includes(lastDigit)) {
        publicKey = EMAILJS_KEY_1;
        serviceId = "UserTaskTimes";
        templateId = "template_9x49afd";
    } else {
        publicKey = EMAILJS_KEY_2;
        serviceId = "UserTaskTimes2";
        templateId = "template_zyhrlrh";
    }

    // Initialize then send
    emailjs.init(publicKey);
    emailjs.send(serviceId, templateId, params)
        .then(function(response) {
            if (callback) callback(true);
        }, function(error) {
            if (callback) callback(false);
        });
}

// 🟢 GEOCODER
var osmGeocoder = new L.Control.Geocoder({
    collapsed: true,
    position: 'topleft',
    text: 'Search',
    title: 'Testing',
    defaultMarkGeocode: false // <-- Prevent default marker!
}).addTo(map);

document.getElementsByClassName('leaflet-control-geocoder-icon')[0]
    .className += ' fa fa-search';
document.getElementsByClassName('leaflet-control-geocoder-icon')[0]
    .title += 'Search for a place';
setBounds();

// Track the last search marker
let lastSearchMarker = null;

osmGeocoder.on('markgeocode', function(e) {
    if (lastSearchMarker) {
        map.removeLayer(lastSearchMarker);
    }
    lastSearchMarker = L.marker(e.geocode.center)
        .addTo(map)
        .bindPopup(e.geocode.name)
        .openPopup();

    map.setView(e.geocode.center, map.getZoom());

    // Optional: Ensure clicking the marker shows the popup
    lastSearchMarker.on('click', function() {
        lastSearchMarker.openPopup();
    });
});

// Remove search marker when clicking anywhere on the map (except the marker itself)
map.on('click', function(e) {
    // Check if click was NOT on the marker
    if (lastSearchMarker && (!e.originalEvent || !e.originalEvent.target.classList.contains('leaflet-marker-icon'))) {
        map.removeLayer(lastSearchMarker);
        lastSearchMarker = null;
    }
});


// ...existing code...

        </script>
    </body>
</html>
